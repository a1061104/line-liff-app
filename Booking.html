<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾å®¹é ç´„</title>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script> <style>
        body { font-family: -apple-system, "Helvetica Neue", sans-serif; background-color: #fce4ec; padding: 20px; color: #333; }
        .container { background: white; max-width: 500px; margin: 0 auto; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h3 { text-align: center; color: #d81b60; margin-bottom: 25px; font-size: 22px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 14px; }
        .input-group { display: flex; gap: 10px; align-items: center; }
        
        .form-control, .form-select { 
            width: 100%; height: 48px; padding: 0 12px; border: 1px solid #ddd; 
            border-radius: 8px; box-sizing: border-box; font-size: 16px; 
            background-color: #fff; color: #333; outline: none; 
            -webkit-appearance: none; appearance: none; display: block; line-height: 48px; 
        }

        /* è®“æ—¥æœŸæ¬„ä½çœ‹èµ·ä¾†åƒæŒ‰éˆ•ï¼Œä¸”åœ¨æ‰‹æ©Ÿä¸Šä¸æœƒè·³å‡ºéµç›¤ */
        #r_date { background-color: #fff; cursor: pointer; } 

        .form-select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d81b60%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 12px auto; padding-right: 30px;
        }
        
        .btn-small { height: 48px; white-space: nowrap; background-color: #ff9800; color: white; border: none; border-radius: 8px; padding: 0 15px; font-size: 14px; cursor: pointer; font-weight: bold; flex-shrink: 0; }
        .btn { width: 100%; padding: 14px; background-color: #d81b60; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold; margin-top: 15px; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column; }
        .holiday-badge { margin-top: 8px; padding: 8px 12px; background-color: #fff9c4; border-left: 4px solid #fbc02d; font-size: 13px; color: #7f6e00; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="loading-mask"><div style="font-weight:bold; font-size:18px; color:#d81b60;">è³‡æ–™è®€å–ä¸­...</div></div>

    <div class="container">
        <h3>ğŸ› é ç´„ç¾å®¹ / ä½å®¿</h3>
        
        <div class="form-group">
            <label>é¸æ“‡å¯µç‰©</label>
            <div class="input-group">
                <select id="pet_select" class="form-select"><option value="">è®€å–ä¸­...</option></select>
                <button type="button" class="btn-small" onclick="location.href='Pet.html'">å»ºç«‹æ¯›å°å­©</button>
            </div>
        </div>
        
        <div class="form-group">
            <label>æŒ‡å®šç¾å®¹å¸«</label>
            <select id="beautician_select" class="form-select"><option value="">è®€å–ä¸­...</option></select>
        </div>
        
        <div class="form-group">
            <label>é ç´„æ—¥æœŸ (åƒ…é–‹æ”¾æ˜å¤©ä»¥å¾Œ)</label>
            <input type="text" id="r_date" class="form-control" placeholder="è«‹é»é¸æ—¥æœŸ" readonly>
            <div id="holiday-info" class="holiday-badge" style="display:none;"></div>
        </div>
        
        <div class="form-group">
            <label>é ç´„æ™‚é–“ <span id="time-hint" style="font-weight:normal; font-size:0.95em; color:#d81b60;"></span></label>
            <input type="time" id="r_time" class="form-control">
        </div>
        
        <div class="form-group">
            <label>æœå‹™é …ç›®</label>
            <select id="r_service" class="form-select"><option value="">è®€å–ä¸­...</option></select>
        </div>
        
        <button id="btn-submit" class="btn" onclick="submitReservation()">é€å‡ºé ç´„</button>
    </div>

    <script>
        // ==========================================
        // 1. è¨­å®šå€ (è«‹ç¢ºèª ID èˆ‡ URL æ­£ç¢º)
        // ==========================================
        const MY_LIFF_ID = '2008965576-OEL8Wsmc'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxzciNP_1cdq9XBnfcgTj5gv_QEt2xk-cevUsocHJx5j4IxjhJvS9DHHz1hhPXzDQHl/exec';
        
        let currentUserId = '';
        let g_openTime = "09:00";
        let g_closeTime = "21:00";
        let g_holidays = []; // å„²å­˜åº—ä¼‘æ—¥ (0=é€±æ—¥, 1=é€±ä¸€...)

        // ==========================================
        // 2. åˆå§‹åŒ–æµç¨‹
        // ==========================================
        window.onload = function() {
            // å…ˆè®€å–å¾Œç«¯è¨­å®š (ç‡Ÿæ¥­æ™‚é–“ã€åº—ä¼‘æ—¥)ï¼Œè®€å®Œå†åˆå§‹åŒ–æ—¥æ›†
            loadSettings(); 
            loadBeauticians(); 
            loadServices();
            
            // LIFF åˆå§‹åŒ–
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                } else { 
                    liff.getProfile().then(p => { 
                        currentUserId = p.userId; 
                        loadUserPets(); 
                    }); 
                }
            }).catch(err => {
                console.error('LIFF Init Failed:', err);
                // å³ä½¿ LIFF å¤±æ•—ä¹Ÿé—œé–‰é®ç½©ï¼Œè®“ç¶²é èƒ½é¡¯ç¤º (æ–¹ä¾¿é™¤éŒ¯)
                document.getElementById('loading-mask').style.display = 'none';
            });
        };

        // ==========================================
        // 3. è³‡æ–™è®€å–å‡½å¼
        // ==========================================
        function loadSettings() {
            fetch(GAS_URL + `?action=reservation_get_settings`).then(res => res.json()).then(res => {
                if (res.status === 'success') {
                    g_openTime = res.data.OPEN_HOUR; 
                    g_closeTime = res.data.CLOSE_HOUR; 
                    g_holidays = res.data.WEEKLY_HOLIDAY || [];
                    
                    document.getElementById('time-hint').innerText = `(è«‹æ–¼ç‡Ÿæ¥­æ™‚é–“ ${g_openTime}~${g_closeTime} å…§å¡«å¯«)`;
                    
                    // é¡¯ç¤ºåº—ä¼‘æ—¥æç¤º
                    if (g_holidays.length > 0) {
                        const weekNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
                        const hNames = g_holidays.map(h => weekNames[h]).join('ã€');
                        document.getElementById('holiday-info').style.display = 'block';
                        document.getElementById('holiday-info').innerText = `ğŸ’¡ æœ¬åº—æ¯é€±ï¼ˆ${hNames}ï¼‰å›ºå®šåº—ä¼‘ã€‚`;
                    }

                    // âœ… è¨­å®šè®€å–å®Œç•¢å¾Œï¼Œåˆå§‹åŒ– Flatpickr æ—¥æ›†
                    initFlatpickr();
                }
            });
        }

        function loadUserPets() {
            fetch(GAS_URL + `?action=pet_query_list&u_id=${encodeURIComponent(currentUserId)}`).then(res => res.json()).then(res => {
                document.getElementById('loading-mask').style.display = 'none';
                const s = document.getElementById('pet_select'); 
                s.innerHTML = '';
                if (res.status === 'success' && res.data.length > 0) {
                    res.data.forEach(p => s.add(new Option(p.p_name, p.p_id)));
                } else {
                    Swal.fire('å°šæœªå»ºæª”', 'åµæ¸¬åˆ°æ‚¨å°šæœªå»ºç«‹å¯µç‰©æª”æ¡ˆï¼Œè«‹å…ˆå®Œæˆå»ºæª”ã€‚', 'warning').then(() => { window.location.href = 'index.html'; });
                }
            });
        }

        function loadBeauticians() { 
            fetch(GAS_URL + `?action=reservation_beautician_list`).then(res => res.json()).then(res => { 
                const s = document.getElementById('beautician_select'); 
                s.innerHTML = ''; 
                s.add(new Option("ä¸æŒ‡å®š", "")); 
                if (res.status === 'success') res.data.forEach(b => s.add(new Option(b.b_name, b.b_id))); 
            }); 
        }

        function loadServices() { 
            fetch(GAS_URL + `?action=reservation_service_list`).then(res => res.json()).then(res => { 
                const s = document.getElementById('r_service'); 
                s.innerHTML = ''; 
                if (res.status === 'success') res.data.forEach(srv => s.add(new Option(srv.name, srv.code))); 
            }); 
        }

        // ==========================================
        // 4. æ—¥æ›†åˆå§‹åŒ– (Flatpickr)
        // ==========================================
        function initFlatpickr() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);

            flatpickr("#r_date", {
                locale: "zh_tw",      // èªè¨€ï¼šç¹é«”ä¸­æ–‡
                minDate: tomorrow,    // æœ€å°æ—¥æœŸï¼šæ˜å¤© (ä»Šå¤©ä»¥å‰è‡ªå‹•è®Šç°)
                dateFormat: "Y-m-d",  // æ ¼å¼ï¼š2023-10-10
                
                // âœ… é—œéµï¼šæ‰‹æ©Ÿæ¨¡å¼è¨­å®š
                disableMobile: "true", // å¼·åˆ¶åœ¨æ‰‹æ©Ÿä¸Šä¹Ÿä½¿ç”¨æ­¤ä»‹é¢ (è‹¥è¨­ç‚º false æœƒè·³å‡ºåŸç”Ÿæ»¾è¼ªï¼Œå°è‡´ç„¡æ³•è®Šç°)
                
                // âœ… é—œéµï¼šä¸€æ¬¡åªé¡¯ç¤ºä¸€å€‹æœˆ
                showMonths: 1,

                // âœ… é—œéµï¼šè‡ªè¨‚ç¦æ­¢æ—¥æœŸ (åº—ä¼‘æ—¥)
                disable: [
                    function(date) {
                        // å¦‚æœè©²æ—¥æœŸçš„æ˜ŸæœŸå¹¾ (0~6) åœ¨åº—ä¼‘æ—¥é™£åˆ—ä¸­ï¼Œå‰‡å›å‚³ true (é–ä½)
                        return g_holidays.includes(date.getDay());
                    }
                ]
            });
        }

        // ==========================================
        // 5. é€å‡ºé ç´„ (å« LINE è¨Šæ¯ç™¼é€)
        // ==========================================
        function submitReservation() {
            // (1) å–å¾—æ¬„ä½
            const petSelect = document.getElementById('pet_select');
            const beauticianSelect = document.getElementById('beautician_select');
            const dateInput = document.getElementById('r_date');
            const timeInput = document.getElementById('r_time');
            const srvSelect = document.getElementById('r_service');
            const btn = document.getElementById('btn-submit');

            // (2) å–å¾—å€¼èˆ‡æ–‡å­—
            const p_id = petSelect.value;
            const b_id = beauticianSelect.value;
            const date = dateInput.value;
            const time = timeInput.value;
            const srvCode = srvSelect.value;

            // å–å¾—é¸å–®çš„æ–‡å­— (ç”¨æ–¼è¨Šæ¯é¡¯ç¤º)
            let p_name = "";
            let s_name = "";
            if (petSelect.selectedIndex >= 0) p_name = petSelect.options[petSelect.selectedIndex].text;
            if (srvSelect.selectedIndex >= 0) s_name = srvSelect.options[srvSelect.selectedIndex].text;

            // (3) é©—è­‰
            if (!p_id || !date || !time || !srvCode) { 
                Swal.fire('è«‹æª¢æŸ¥', 'è«‹å¡«å¯«å®Œæ•´é ç´„è³‡è¨Š', 'error'); 
                return; 
            }

            // (4) é–å®šæŒ‰éˆ•
            btn.disabled = true; 
            btn.innerText = 'è™•ç†ä¸­...';

            const params = `?action=reservation_save` + 
                           `&u_id=${encodeURIComponent(currentUserId)}` + 
                           `&p_id=${encodeURIComponent(p_id)}` + 
                           `&b_id=${encodeURIComponent(b_id)}` + 
                           `&date=${encodeURIComponent(date)}` + 
                           `&time=${encodeURIComponent(time)}` + 
                           `&service=${encodeURIComponent(srvCode)}`;

            // (5) å‘¼å«å¾Œç«¯ API
            fetch(GAS_URL + params).then(res => res.json()).then(res => {
                if (res.status === 'success') {
                    
                    // âœ… æˆåŠŸï¼šæª¢æŸ¥æ˜¯å¦åœ¨ LINE å…§ï¼Œç™¼é€è¨Šæ¯
                    if (liff.isInClient()) {
                        liff.sendMessages([
                            {
                                "type": "text",
                                "text": "âœ… é ç´„ç”³è«‹å·²é€å‡ºï¼\n" +
                                        "------------------\n" +
                                        "ğŸ¶ å¯µç‰©åç¨±ï¼š" + p_name + "\n" +
                                        "ğŸ“… é ç´„æ—¥æœŸï¼š" + date + "\n" +
                                        "â° é ç´„æ™‚é–“ï¼š" + time + "\n" +
                                        "ğŸ›€ æœå‹™é …ç›®ï¼š" + s_name + "\n" +
                                        "âœ¨ é ç´„å–®è™Ÿï¼š" + res.r_id + "\n\n" +
                                        "æˆ‘å€‘å°‡ç›¡å¿«ç‚ºæ‚¨ç¢ºèªï¼Œè¬è¬ï¼"
                            }
                        ]).then(() => {
                            // è¨Šæ¯ç™¼é€æˆåŠŸ -> é¡¯ç¤ºæˆåŠŸè¦–çª— -> é—œé–‰
                            Swal.fire('é ç´„æˆåŠŸ', `é ç´„å–®è™Ÿï¼š${res.r_id}`, 'success').then(() => {
                                liff.closeWindow();
                            });
                        }).catch((err) => {
                            // è¨Šæ¯ç™¼é€å¤±æ•— (å¯èƒ½æ˜¯æ¬Šé™å•é¡Œ) -> é¡¯ç¤ºæˆåŠŸè¦–çª— -> é—œé–‰
                            console.error('Message Error:', err);
                            Swal.fire('é ç´„æˆåŠŸ', `é ç´„å–®è™Ÿï¼š${res.r_id} (é€šçŸ¥ç™¼é€å¤±æ•—)`, 'success').then(() => {
                                liff.closeWindow();
                            });
                        });
                    } else {
                        // ä¸åœ¨ LINE å…§ (ä¸€èˆ¬ç€è¦½å™¨)
                        Swal.fire('é ç´„æˆåŠŸ', `é ç´„å–®è™Ÿï¼š${res.r_id}`, 'success');
                        btn.disabled = false; 
                        btn.innerText = 'é€å‡ºé ç´„';
                    }

                } else {
                    // âŒ å¤±æ•— (å¾Œç«¯é‚è¼¯éŒ¯èª¤ï¼Œå¦‚é¡æ»¿æˆ–åƒæ•¸éŒ¯)
                    Swal.fire('é ç´„å¤±æ•—', res.message, 'error');
                    btn.disabled = false; 
                    btn.innerText = 'é€å‡ºé ç´„';
                }
            }).catch(() => { 
                Swal.fire('é€£ç·šéŒ¯èª¤', 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error'); 
                btn.disabled = false; 
                btn.innerText = 'é€å‡ºé ç´„'; 
            });
        }
    </script>
</body>
</html>
