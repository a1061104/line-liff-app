<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾å®¹é ç´„</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, "Helvetica Neue", sans-serif; background-color: #fce4ec; padding: 20px; color: #333; }
        .container { background: white; max-width: 500px; margin: 0 auto; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h3 { text-align: center; color: #d81b60; margin-bottom: 25px; font-size: 22px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 14px; }
        .input-group { display: flex; gap: 10px; align-items: center; }
        .form-control, .form-select { width: 100%; height: 48px; padding: 0 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background-color: #fff; color: #333; outline: none; -webkit-appearance: none; appearance: none; display: block; line-height: 48px; }
        .form-select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d81b60%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 12px auto; padding-right: 30px; }
        .btn-small { height: 48px; white-space: nowrap; background-color: #ff9800; color: white; border: none; border-radius: 8px; padding: 0 15px; font-size: 14px; cursor: pointer; font-weight: bold; flex-shrink: 0; transition: background-color 0.2s; }
        .btn { width: 100%; padding: 14px; background-color: #d81b60; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold; margin-top: 15px; -webkit-tap-highlight-color: transparent; }
        .btn:active { background-color: #ad1457; }
        .btn:disabled { background-color: #f48fb1; cursor: not-allowed; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading-mask"><div style="font-weight:bold; font-size:18px; color:#d81b60;">è³‡æ–™è®€å–ä¸­...</div></div>
    <div class="container">
        <h3>ğŸ› é ç´„ç¾å®¹ / ä½å®¿</h3>
        <div class="form-group">
            <label>é¸æ“‡å¯µç‰©</label>
            <div class="input-group">
                <select id="pet_select" class="form-select"><option value="">è®€å–ä¸­...</option></select>
                <button type="button" class="btn-small" onclick="location.href='Pet.html'">å»ºç«‹æ¯›å°å­©</button>
            </div>
        </div>
        <div class="form-group">
            <label>æŒ‡å®šç¾å®¹å¸«</label>
            <select id="beautician_select" class="form-select"><option value="">è®€å–ä¸­...</option></select>
        </div>
        <div class="form-group">
            <label>é ç´„æ—¥æœŸ <span id="date-hint" style="font-weight:normal; font-size:0.85em; color:#d81b60;">(2026/03/01 æ­£å¼é–‹å¹•)</span></label>
            <input type="date" id="r_date" class="form-control">
        </div>
        <div class="form-group">
            <label>é ç´„æ™‚é–“ <span id="time-hint" style="font-weight:normal; font-size:0.85em; color:#d81b60;">(ä¾ç‡Ÿæ¥­æ™‚é–“å¡«å¯«)</span></label>
            <input type="time" id="r_time" class="form-control">
        </div>
        <div class="form-group">
            <label>æœå‹™é …ç›®</label>
            <select id="r_service" class="form-select"><option value="">è®€å–ä¸­...</option></select>
        </div>
        <button id="btn-submit" class="btn" onclick="submitReservation()">é€å‡ºé ç´„</button>
    </div>

    <script>
        const MY_LIFF_ID = '2008965576-OEL8Wsmc'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzteHr3C5uweBFj6FQCUtQfEEyDQpf7EIkb0vUuoiEmnPLgc37G894IbGNgvI3-5iYISg/exec';
        let currentUserId = '';
        let g_openTime = "09:00", g_closeTime = "21:00";

        // âœ… è¼”åŠ©å‡½å¼ï¼šç¢ºä¿æ—¥æœŸæ ¼å¼æ­£ç¢ºä¸”ä¸åç§»
        function formatDateToYYYYMMDD(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        window.onload = function() {
            const dateInput = document.getElementById('r_date');
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // ğŸš€ è¨­å®šé–‹å¹•æ—¥æœŸç‚º 2026/03/01
            const openingDate = new Date(2026, 2, 1); // 2 = ä¸‰æœˆ
            
            // å–ã€Œæ˜å¤©ã€èˆ‡ã€Œé–‹å¹•æ—¥ã€è¼ƒæ™šçš„é‚£ä¸€å¤©
            let minDate = (tomorrow > openingDate) ? tomorrow : openingDate;
            const minStr = formatDateToYYYYMMDD(minDate);

            dateInput.min = minStr;
            dateInput.value = minStr;

            dateInput.addEventListener('change', function() {
                if (this.value < minStr) {
                    alert(now < openingDate ? 'æœ¬åº—å°‡æ–¼ 2026/03/01 æ­£å¼é–‹å¹•ï¼Œè«‹é‡æ–°é¸æ“‡æ—¥æœŸã€‚' : 'é ç´„æ—¥æœŸæœ€æ—©åƒ…é™å¾æ˜å¤©é–‹å§‹ã€‚');
                    this.value = minStr;
                }
            });

            loadSettings(); loadBeauticians(); loadServices();
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) liff.login();
                else liff.getProfile().then(p => { currentUserId = p.userId; loadUserPets(); });
            }).catch(e => console.error(e));
        };

        function loadSettings() { fetch(GAS_URL + `?action=reservation_get_settings`).then(r => r.json()).then(res => { if (res.status === 'success') { g_openTime = res.data.OPEN_HOUR; g_closeTime = res.data.CLOSE_HOUR; document.getElementById('time-hint').innerText = `(ç‡Ÿæ¥­æ™‚é–“ ${g_openTime}~${g_closeTime})`; } }); }
        function loadBeauticians() { fetch(GAS_URL + `?action=reservation_beautician_list`).then(r => r.json()).then(res => { const s = document.getElementById('beautician_select'); s.innerHTML = ''; s.add(new Option("ä¸æŒ‡å®š (Any)", "")); if (res.status === 'success') res.data.forEach(b => s.add(new Option(b.b_name, b.b_id))); }); }
        function loadServices() { fetch(GAS_URL + `?action=reservation_service_list`).then(r => r.json()).then(res => { const s = document.getElementById('r_service'); s.innerHTML = ''; if (res.status === 'success') res.data.forEach(srv => s.add(new Option(srv.name, srv.code))); }); }
        function loadUserPets() { fetch(GAS_URL + `?action=pet_query_list&u_id=${encodeURIComponent(currentUserId)}`).then(r => r.json()).then(res => { document.getElementById('loading-mask').style.display = 'none'; const s = document.getElementById('pet_select'); s.innerHTML = ''; if (res.status === 'success' && res.data.length > 0) res.data.forEach(p => s.add(new Option(p.p_name, p.p_id))); else { alert('è«‹å…ˆå»ºç«‹å¯µç‰©æª”æ¡ˆ'); window.location.href = 'index.html'; } }); }

        function submitReservation() {
            const petS = document.getElementById('pet_select'), bS = document.getElementById('beautician_select'),
                  date = document.getElementById('r_date').value, time = document.getElementById('r_time').value,
                  srvS = document.getElementById('r_service'), btn = document.getElementById('btn-submit');
            
            if (!date || !time) return alert('è«‹å¡«å¯«æ—¥æœŸèˆ‡æ™‚é–“');
            const [h, m] = time.split(':').map(Number), userM = h * 60 + m;
            const [oH, oM] = g_openTime.split(':').map(Number), openM = oH * 60 + oM;
            const [cH, cM] = g_closeTime.split(':').map(Number), closeM = cH * 60 + cM;
            if (userM < openM || userM > closeM) return alert(`é ç´„å¤±æ•—ï¼šç‡Ÿæ¥­æ™‚é–“ç‚º ${g_openTime} è‡³ ${g_closeTime}`);

            btn.disabled = true; btn.innerText = 'è™•ç†ä¸­...';
            const params = `?action=reservation_save&u_id=${encodeURIComponent(currentUserId)}&p_id=${encodeURIComponent(petS.value)}&b_id=${encodeURIComponent(bS.value)}&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}&service=${encodeURIComponent(srvS.value)}`;
            fetch(GAS_URL + params).then(r => r.json()).then(res => {
                if (res.status === 'success') {
                    const msg = `âœ… é ç´„ç”³è«‹å·²é€å‡ºï¼\nğŸ¶ å¯µç‰©ï¼š${petS.options[petS.selectedIndex].text}\nğŸ“… æ—¥æœŸï¼š${date}\nâ° æ™‚é–“ï¼š${time}\nâœ¨ å–®è™Ÿï¼š${res.r_id}`;
                    if (liff.isInClient()) liff.sendMessages([{type: 'text', text: msg}]).then(() => liff.closeWindow());
                    else alert(msg);
                } else { alert(res.message); btn.disabled = false; btn.innerText = 'é€å‡ºé ç´„'; }
            }).catch(() => { alert('é€£ç·šéŒ¯èª¤'); btn.disabled = false; });
        }
    </script>
</body>
</html>
