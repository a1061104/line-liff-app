/**
 * ğŸš€ å¾ Par_Setting å·¥ä½œè¡¨ç²å–é…ç½®
 */
function getReservationSettings() {
  var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  var sheet = ss.getSheetByName('Par_Setting');
  var settings = {};
  if (!sheet) throw new Error('æ‰¾ä¸åˆ° Par_Setting å·¥ä½œè¡¨');
  
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    var gsName = data[i][0];
    var parName = data[i][1];
    var val = data[i][3];
    
    if (gsName === 'code_Reservation.gs') {
      if (parName === 'OPEN_HOUR' || parName === 'CLOSE_HOUR') {
        settings[parName] = (val instanceof Date) ? Utilities.formatDate(val, Session.getScriptTimeZone(), "HH:mm") : val.toString();
      } else if (parName === 'DURATION_MIN') {
        settings[parName] = parseInt(val, 10);
      }
    }
  }
  return settings;
}

/**
 * ğŸš€ å–å¾—æœ‰æ•ˆç¾å®¹å¸«æ¸…å–®
 */
function getActiveBeauticians(ss) {
  var sheet = ss.getSheetByName('Beautician');
  if (!sheet) return [];
  var data = sheet.getDataRange().getValues();
  var list = [];
  for (var i = 1; i < data.length; i++) {
    // å‡è¨­ B_Flag åœ¨ç¬¬ 4 æ¬„ (ç´¢å¼• 3)
    if (data[i][3] == 1 && data[i][0]) {
      list.push({ b_id: data[i][0], b_name: data[i][1] });
    }
  }
  return list;
}

/**
 * ğŸš€ å¾ Basic_Data å–å¾—æœå‹™é¸å–®
 */
function getServiceOptions(ss) {
  var sheet = ss.getSheetByName('Basic_Data');
  if (!sheet) return [];
  var data = sheet.getDataRange().getValues();
  var list = [];
  for (var i = 1; i < data.length; i++) {
    // A=TB_Name, B=Cul_Name, C=Code, D=Code_Desc, E=Flag
    if (data[i][0] === 'Reservation' && data[i][1] === 'R_Server' && data[i][4] == 1) {
      list.push({ code: data[i][2], name: data[i][3] });
    }
  }
  return list;
}

/**
 * ğŸš€ è™•ç†é ç´„é‚è¼¯æ ¸å¿ƒ
 */
function handleReservationLogic(params) {
  try {
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var action = params.action;
    var now = new Date();

    if (action === 'reservation_get_settings') {
      return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: getReservationSettings() })).setMimeType(ContentService.MimeType.JSON);
    }
    
    if (action === 'reservation_beautician_list') {
      return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: getActiveBeauticians(ss) })).setMimeType(ContentService.MimeType.JSON);
    }
    
    if (action === 'reservation_service_list') {
      return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: getServiceOptions(ss) })).setMimeType(ContentService.MimeType.JSON);
    }

    if (action === 'reservation_save') {
      var config = getReservationSettings();
      // âœ… ä¾ç…§åœ–ç‰‡æ›´æ–°ç‚º 14 æ¬„ä½
      var sheet = getOrCreateSheet(ss, 'Reservation', [
        'R_ID', 'R_Date', 'R_StartTime', 'R_EndTime', 'U_ID', 'P_ID', 'R_Server', 'B_ID', 
        'R_Flag', 'R_Confirm', 'R_CheckIn', 'R_SyncCal', 'CreateDate', 'Update_Time'
      ]);

      var dateParts = params.date.split('-');
      var selectedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
      
      // ğŸš€ 1. é–‹å¹•æ—¥æª¢æŸ¥ (2026/03/01)
      var openingDate = new Date(2026, 2, 1);
      if (selectedDate < openingDate) {
        return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'é ç´„å¤±æ•—ï¼šæœ¬åº—å°‡æ–¼ 2026/03/01 æ­£å¼é–‹å¹•ã€‚' })).setMimeType(ContentService.MimeType.JSON);
      }

      // ğŸš€ 2. æ˜æ—¥ä»¥å¾Œæª¢æŸ¥
      var today = new Date(); 
      today.setHours(0, 0, 0, 0);
      if (selectedDate.getTime() <= today.getTime()) {
        return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'é ç´„å¤±æ•—ï¼šåƒ…é–‹æ”¾é ç´„æ˜æ—¥ä»¥å¾Œçš„æ™‚æ®µã€‚' })).setMimeType(ContentService.MimeType.JSON);
      }

      // ğŸš€ 3. ç‡Ÿæ¥­æ™‚é–“æª¢æŸ¥
      var userM = timeToMinutes(params.time);
      var openM = timeToMinutes(config.OPEN_HOUR);
      var closeM = timeToMinutes(config.CLOSE_HOUR);
      if (userM < openM || userM > closeM) {
        return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'ä¸åœ¨ç‡Ÿæ¥­æ™‚é–“å…§ã€‚' })).setMimeType(ContentService.MimeType.JSON);
      }

      var r_id = generateTimestampId(now);
      var endTime = calculateEndTime(params.time, config.DURATION_MIN);
      
      // âœ… ä¾ç…§åœ–ç‰‡é †åºæ’åˆ—è³‡æ–™ (14 æ¬„ä½)
      var rowData = [
        r_id,              // R_ID
        params.date,       // R_Date
        params.time,       // R_StartTime
        endTime,           // R_EndTime
        params.u_id,       // U_ID
        params.p_id,       // P_ID
        params.service,    // R_Server
        params.b_id || '', // B_ID
        '1',               // R_Flag
        '0',               // R_Confirm (æ–°å¢)
        '0',               // R_CheckIn (ä¿®æ”¹å)
        '0',               // R_SyncCal
        now,               // CreateDate
        ''                 // Update_Time
      ];
      
      sheet.appendRow(rowData);
      return ContentService.createTextOutput(JSON.stringify({ status: 'success', r_id: r_id })).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'ç³»çµ±éŒ¯èª¤: ' + e.message })).setMimeType(ContentService.MimeType.JSON);
  }
}

// --- å·¥å…·å‡½å¼ ---
function timeToMinutes(t) { 
  var p = t.split(':'); 
  return parseInt(p[0], 10) * 60 + parseInt(p[1], 10); 
}

function generateTimestampId(d) { 
  var pad = function(n, l) { return n.toString().padStart(l, '0'); };
  return 'R' + d.getFullYear().toString().slice(-2) + pad(d.getMonth() + 1, 2) + pad(d.getDate(), 2) + pad(d.getHours(), 2) + pad(d.getMinutes(), 2) + pad(d.getSeconds(), 2) + Math.floor(d.getMilliseconds() / 100).toString(); 
}

function calculateEndTime(s, dur) { 
  var p = s.split(':'), d = new Date(); 
  d.setHours(p[0], p[1], 0); 
  d.setMinutes(d.getMinutes() + dur); 
  return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0'); 
}
