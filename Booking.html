<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾å®¹é ç´„</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, "Helvetica Neue", sans-serif; background-color: #fce4ec; padding: 20px; color: #333; }
        .container { background: white; max-width: 500px; margin: 0 auto; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h3 { text-align: center; color: #d81b60; margin-bottom: 25px; font-size: 22px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 14px; }
        .input-group { display: flex; gap: 10px; align-items: center; }
        .form-control, .form-select { 
            width: 100%; height: 48px; padding: 0 12px; border: 1px solid #ddd; 
            border-radius: 8px; box-sizing: border-box; font-size: 16px; 
            background-color: #fff; color: #333; outline: none; 
            -webkit-appearance: none; appearance: none; display: block; line-height: 48px; 
        }
        .form-select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d81b60%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 12px auto; padding-right: 30px;
        }
        .btn-small { 
            height: 48px; white-space: nowrap; background-color: #ff9800; color: white; border: none; 
            border-radius: 8px; padding: 0 15px; font-size: 14px; cursor: pointer; font-weight: bold; 
            flex-shrink: 0; transition: background-color 0.2s;
        }
        .btn-small:active { background-color: #e68a00; }
        .btn { width: 100%; padding: 14px; background-color: #d81b60; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold; margin-top: 15px; -webkit-tap-highlight-color: transparent; }
        .btn:active { background-color: #ad1457; }
        .btn:disabled { background-color: #f48fb1; cursor: not-allowed; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading-mask">
        <div style="font-weight:bold; font-size:18px; color:#d81b60;">è³‡æ–™è®€å–ä¸­...</div>
    </div>

    <div class="container">
        <h3>ğŸ› é ç´„ç¾å®¹ / ä½å®¿</h3>
        
        <div class="form-group">
            <label>é¸æ“‡å¯µç‰©</label>
            <div class="input-group">
                <select id="pet_select" class="form-select">
                    <option value="">è®€å–ä¸­...</option>
                </select>
                <button type="button" class="btn-small" onclick="location.href='Pet.html'">å»ºç«‹æ¯›å°å­©</button>
            </div>
        </div>

        <div class="form-group">
            <label>æŒ‡å®šç¾å®¹å¸«</label>
            <select id="beautician_select" class="form-select"><option value="">è®€å–ä¸­...</option></select>
        </div>

        <div class="form-group">
            <label>é ç´„æ—¥æœŸ (åƒ…é–‹æ”¾æ˜å¤©ä»¥å¾Œ)</label>
            <input type="date" id="r_date" class="form-control" onchange="checkDateValidity()">
        </div>

        <div class="form-group">
            <label>é ç´„æ™‚é–“ <span id="time-hint" style="font-weight:normal; font-size:0.95em; color:#d81b60;">(è«‹ä¾ç‡Ÿæ¥­æ™‚é–“å¡«å¯«)</span></label>
            <select id="r_time" class="form-select">
                <option value="">è¼‰å…¥ä¸­...</option>
            </select>
        </div>

        <div class="form-group">
            <label>æœå‹™é …ç›®</label>
            <select id="r_service" class="form-select">
                <option value="">è®€å–ä¸­...</option>
            </select>
        </div>

        <button id="btn-submit" class="btn" onclick="submitReservation()">é€å‡ºé ç´„</button>
    </div>

    <script>
        const MY_LIFF_ID = '2008965576-OEL8Wsmc'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzteHr3C5uweBFj6FQCUtQfEEyDQpf7EIkb0vUuoiEmnPLgc37G894IbGNgvI3-5iYISg/exec';
        let currentUserId = '';

        let g_openTime = "09:00"; 
        let g_closeTime = "21:00";
        let g_weeklyHoliday = null; 
        let g_specialHolidays = {}; 

        window.onload = function() {
            const dateInput = document.getElementById('r_date');
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const year = tomorrow.getFullYear();
            const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const day = String(tomorrow.getDate()).padStart(2, '0');
            dateInput.min = `${year}-${month}-${day}`;
            dateInput.value = dateInput.min;

            loadSettings();     
            loadBeauticians();
            loadServices(); 

            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) { liff.login(); } 
                else { liff.getProfile().then(profile => { currentUserId = profile.userId; loadUserPets(); }); }
            }).catch(err => { console.error('LIFF Init Error', err); });
        };

        function loadSettings() {
            fetch(GAS_URL + `?action=reservation_get_settings`)
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    const config = result.data;
                    g_openTime = config.OPEN_HOUR;   
                    g_closeTime = config.CLOSE_HOUR; 
                    g_weeklyHoliday = config.WEEKLY_HOLIDAY; 
                    g_specialHolidays = result.holidays || {};

                    let holidayText = "";
                    if (g_weeklyHoliday !== null) {
                        const days = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
                        holidayText = `ï¼Œé€±${days[g_weeklyHoliday]}å…¬ä¼‘`;
                    }

                    document.getElementById('time-hint').innerText = `(ç‡Ÿæ¥­æ™‚é–“ ${g_openTime}~${g_closeTime}${holidayText})`;
                    
                    // ğŸš€ æ ¸å¿ƒä¿®æ”¹ï¼šç”¢ç”Ÿæ™‚é–“ä¸‹æ‹‰é¸å–®
                    generateTimeSlots(g_openTime, g_closeTime);

                    checkDateValidity();
                }
            })
            .catch(err => console.error("è®€å–è¨­å®šå¤±æ•—", err));
        }

        // ğŸš€ æ–°å¢å‡½å¼ï¼šæ ¹æ“šç‡Ÿæ¥­æ™‚é–“ç”¢ç”Ÿ 10 åˆ†é˜é–“éš”çš„é¸é …
        function generateTimeSlots(startStr, endStr) {
            const select = document.getElementById('r_time');
            select.innerHTML = '<option value="">è«‹é¸æ“‡æ™‚é–“</option>';

            const [startH, startM] = startStr.split(':').map(Number);
            const [endH, endM] = endStr.split(':').map(Number);

            let currentMins = startH * 60 + startM;
            const endMins = endH * 60 + endM;

            // è¿´åœˆï¼šå¾é–‹å§‹æ™‚é–“è·‘åˆ°çµæŸæ™‚é–“ï¼Œæ¯æ¬¡åŠ  10 åˆ†é˜
            // æ¢ä»¶è¨­ç‚º < endMinsï¼Œè¡¨ç¤ºä¸åŒ…å«æ‰“çƒŠé‚£ä¸€åˆ» (ä¾‹å¦‚ 21:00 æ‰“çƒŠï¼Œæœ€å¾Œé ç´„æ™‚é–“å¯èƒ½æ˜¯ 20:50)
            while (currentMins < endMins) {
                const h = Math.floor(currentMins / 60);
                const m = currentMins % 60;
                
                // è£œé›¶æ ¼å¼åŒ– (9:0 -> 09:00)
                const timeLabel = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
                
                select.add(new Option(timeLabel, timeLabel));
                
                currentMins += 10; // é–“éš” 10 åˆ†é˜
            }
        }

        function checkDateValidity() {
            const dateInput = document.getElementById('r_date');
            const val = dateInput.value;
            if (!val) return;

            const selectedDate = new Date(val);
            const dayOfWeek = selectedDate.getDay(); 

            if (g_weeklyHoliday !== null && dayOfWeek === g_weeklyHoliday) {
                alert('â›” æŠ±æ­‰ï¼Œæ¯é€±' + ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][g_weeklyHoliday] + 'ç‚ºå›ºå®šå…¬ä¼‘æ—¥ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸã€‚');
                dateInput.value = ''; 
                return;
            }

            if (g_specialHolidays[val]) {
                alert('â›” æŠ±æ­‰ï¼Œè©²æ—¥ç‚ºä¼‘æ¯æ—¥ï¼š' + g_specialHolidays[val]);
                dateInput.value = ''; 
                return;
            }
        }

        function loadBeauticians() {
            fetch(GAS_URL + `?action=reservation_beautician_list`)
            .then(res => res.json())
            .then(result => {
                const select = document.getElementById('beautician_select');
                select.innerHTML = ''; 
                select.add(new Option("ä¸æŒ‡å®š (Any)", ""));
                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(b => { select.add(new Option(b.b_name, b.b_id)); });
                }
            })
            .catch(err => { document.getElementById('beautician_select').innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>'; });
        }

        function loadServices() {
            fetch(GAS_URL + `?action=reservation_service_list`)
            .then(res => res.json())
            .then(result => {
                const select = document.getElementById('r_service');
                select.innerHTML = ''; 
                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(srv => { select.add(new Option(srv.name, srv.code)); });
                } else { select.add(new Option("ç„¡æ³•è¼‰å…¥æœå‹™é …ç›®", "")); }
            })
            .catch(err => { document.getElementById('r_service').innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>'; });
        }

        function loadUserPets() {
            fetch(GAS_URL + `?action=pet_query_list&u_id=${encodeURIComponent(currentUserId)}`)
            .then(res => res.json())
            .then(result => {
                document.getElementById('loading-mask').style.display = 'none';
                const select = document.getElementById('pet_select');
                select.innerHTML = '';
                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(pet => { select.add(new Option(pet.p_name, pet.p_id)); });
                } else {
                    alert('âš ï¸ ç³»çµ±åµæ¸¬åˆ°æ‚¨å°šæœªå»ºç«‹æ¯›å°å­©æª”æ¡ˆï¼Œè«‹å…ˆå®Œæˆå»ºæª”å†é€²è¡Œé ç´„ã€‚');
                    window.location.href = 'index.html';
                }
            })
            .catch(err => { document.getElementById('loading-mask').style.display = 'none'; alert('è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†'); });
        }

        function submitReservation() {
            const petSelect = document.getElementById('pet_select');
            const p_id = petSelect.value;
            const p_name = petSelect.options[petSelect.selectedIndex].text;
            
            const bSelect = document.getElementById('beautician_select');
            const b_id = bSelect.value;
            const b_name = bSelect.options[bSelect.selectedIndex].text;

            const date = document.getElementById('r_date').value;
            const time = document.getElementById('r_time').value;
            const sSelect = document.getElementById('r_service');
            const serviceCode = sSelect.value; 
            
            if (!p_id || p_id === "") { alert('è«‹å…ˆå»ºç«‹ä¸¦é¸æ“‡å¯µç‰©'); return; }
            if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
            if (!time) { alert('è«‹é¸æ“‡æ™‚é–“'); return; }
            if (!serviceCode) { alert('è«‹é¸æ“‡æœå‹™é …ç›®'); return; }

            // é©—è­‰é€šéå¾Œï¼Œå¾Œç«¯æª¢æŸ¥é‚è¼¯ä¿æŒä¸è®Š
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = 'è™•ç†ä¸­...';

            const params = `?action=reservation_save` +
                           `&u_id=${encodeURIComponent(currentUserId)}` +
                           `&p_id=${encodeURIComponent(p_id)}` +
                           `&b_id=${encodeURIComponent(b_id)}` +
                           `&date=${encodeURIComponent(date)}` +
                           `&time=${encodeURIComponent(time)}` +
                           `&service=${encodeURIComponent(serviceCode)}`;

            fetch(GAS_URL + params)
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    if (liff.isInClient()) {
                        let msg = "âœ… é ç´„ç”³è«‹å·²é€å‡ºï¼\n------------------\nğŸ¶ å¯µç‰©åç¨±ï¼š" + p_name + "\nğŸ“… é ç´„æ—¥æœŸï¼š" + date + "\nâ° é ç´„æ™‚é–“ï¼š" + time + "\nğŸ’‡ æŒ‡å®šç¾å®¹å¸«ï¼š" + b_name + "\nâœ¨ é ç´„å–®è™Ÿï¼š" + result.r_id;
                        liff.sendMessages([{ "type": "text", "text": msg }])
                        .then(() => { liff.closeWindow(); })
                        .catch(() => { alert('é ç´„æˆåŠŸï¼Œå–®è™Ÿï¼š' + result.r_id); liff.closeWindow(); });
                    } else { alert('é ç´„æˆåŠŸï¼å–®è™Ÿï¼š' + result.r_id); }
                } else {
                    alert(result.message);
                    btn.disabled = false;
                    btn.innerText = 'é€å‡ºé ç´„';
                }
            })
            .catch(err => {
                alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
                btn.disabled = false;
                btn.innerText = 'é€å‡ºé ç´„';
            });
        }
    </script>
</body>
</html>
