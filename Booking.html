
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å®¹é ç´„</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #fce4ec; padding: 20px; }
        .container { background: white; max-width: 500px; margin: 0 auto; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h3 { text-align: center; color: #d81b60; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-control, .form-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; appearance: none; min-height: 44px; }
        .form-select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d81b60%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; }
        input[type="date"].form-control, input[type="time"].form-control { line-height: 1.4; display: block; }
        .btn { width: 100%; padding: 12px; background-color: #d81b60; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn:disabled { background-color: #f48fb1; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column; }
    </style>
</head>
<body>
    <div id="loading-mask">
        <div style="font-weight:bold; font-size:18px;">è³‡æ–™è®€å–ä¸­...</div>
        <div id="debug-msg" style="font-size:12px; color:#666; margin-top:10px;">åˆå§‹åŒ–...</div>
    </div>

    <div class="container">
        <h3>ğŸ› é ç´„ç¾å®¹ / ä½å®¿</h3>
        <div class="form-group">
            <label>é¸æ“‡å¯µç‰©</label>
            <select id="pet_select" class="form-select"><option value="">è®€å–ä¸­...</option></select>
        </div>
        <div class="form-group"><label>é ç´„æ—¥æœŸ</label><input type="date" id="r_date" class="form-control"></div>
        <div class="form-group"><label>é ç´„æ™‚é–“</label><input type="time" id="r_time" class="form-control"></div>
        <div class="form-group">
            <label>æœå‹™é …ç›®</label>
            <select id="r_service" class="form-select">
                <option value="æ´—æ¾¡">ğŸ› æ´—æ¾¡ (Bath)</option>
                <option value="å¤§ç¾å®¹">âœ‚ï¸ å¤§ç¾å®¹ (Full Grooming)</option>
                <option value="ä½å®¿">ğŸ  ä½å®¿ (Hotel)</option>
                <option value="å®‰è¦ª">ğŸ§¸ å®‰è¦ª (Day Care)</option>
            </select>
        </div>
        <button id="btn-submit" class="btn" onclick="submitReservation()">é€å‡ºé ç´„</button>
    </div>

    <script>
        // âš ï¸ è«‹ç¢ºèªé€™çµ„ LIFF ID æ˜¯æ‚¨å¾Œå°æœ€æ–°çš„é‚£ä¸€çµ„ (ä¸æœƒå ± Invalid çš„é‚£çµ„)
        const MY_LIFF_ID = '2008965576-OEL8Wsmc'; 
        
        // âš ï¸ è«‹ç¢ºèªé€™å€‹ç¶²å€è·Ÿæ‚¨ Pet.html ç”¨çš„ä¸€æ¨¡ä¸€æ¨£ï¼
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyu0lfZZEpSyys4JRpAxukalZqg-6C_p_cBCrxLQaGRdpH66OO1HNovQnkX0GG9tJ6gKw/exec';

        let currentUserId = '';

        function updateDebug(msg) {
            document.getElementById('debug-msg').innerText = msg;
            console.log(msg);
        }

        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('r_date').min = today;

            updateDebug('æ­¥é©Ÿ1: é–‹å§‹ LIFF Init');
            
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                updateDebug('æ­¥é©Ÿ2: LIFF Init æˆåŠŸ');
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    liff.getProfile().then(profile => {
                        currentUserId = profile.userId;
                        updateDebug('æ­¥é©Ÿ3: å–å¾— UserID æˆåŠŸ');
                        loadUserPets();
                    });
                }
            }).catch(err => { 
                alert('LIFF åˆå§‹åŒ–å¤±æ•—: ' + err); 
                updateDebug('éŒ¯èª¤: ' + err);
            });
        };

        function loadUserPets() {
            updateDebug('æ­¥é©Ÿ4: æº–å‚™å‘¼å« Google Sheet...');
            
            // å‘¼å«å¾Œç«¯ API
            fetch(GAS_URL + `?action=pet_query_list&u_id=${encodeURIComponent(currentUserId)}`)
            .then(res => {
                updateDebug('æ­¥é©Ÿ5: ä¼ºæœå™¨æœ‰å›æ‡‰');
                if (!res.ok) throw new Error('ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ ' + res.status);
                return res.json();
            })
            .then(result => {
                updateDebug('æ­¥é©Ÿ6: è³‡æ–™è§£ææˆåŠŸ');
                document.getElementById('loading-mask').style.display = 'none';
                
                const select = document.getElementById('pet_select');
                select.innerHTML = '';
                
                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(pet => {
                        let option = document.createElement('option');
                        option.value = pet.p_id;
                        option.text = pet.p_name;
                        select.appendChild(option);
                    });
                } else {
                    // å¦‚æœ status æ˜¯ errorï¼Œé¡¯ç¤ºå¾Œç«¯å›å‚³çš„éŒ¯èª¤è¨Šæ¯
                    if(result.status === 'error') {
                        alert('å¾Œç«¯éŒ¯èª¤: ' + result.message);
                    } else {
                        let option = document.createElement('option');
                        option.text = "ç„¡å¯µç‰©è³‡æ–™";
                        select.appendChild(option);
                        alert('ç„¡å¯µç‰©è³‡æ–™ï¼Œè«‹å…ˆå»å»ºæª”ï¼');
                    }
                }
            })
            .catch(err => {
                // ğŸ”¥ é€™è£¡æœƒæŠ“å‡ºç‚ºä»€éº¼å¡ä½ï¼
                document.getElementById('loading-mask').style.display = 'none';
                alert('è®€å–å¤±æ•—ï¼åŸå› : ' + err);
            });
        }

        function submitReservation() {
            const p_id = document.getElementById('pet_select').value;
            const date = document.getElementById('r_date').value;
            const time = document.getElementById('r_time').value;
            const service = document.getElementById('r_service').value;

            if (!p_id) { alert('è«‹é¸æ“‡å¯µç‰©'); return; }
            if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
            if (!time) { alert('è«‹é¸æ“‡æ™‚é–“'); return; }

            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = 'è™•ç†ä¸­...';

            const params = `?action=reservation_save` +
                           `&u_id=${encodeURIComponent(currentUserId)}` +
                           `&p_id=${encodeURIComponent(p_id)}` +
                           `&date=${encodeURIComponent(date)}` +
                           `&time=${encodeURIComponent(time)}` +
                           `&service=${encodeURIComponent(service)}`;

            fetch(GAS_URL + params)
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    alert('é ç´„æˆåŠŸï¼å–®è™Ÿï¼š' + result.r_id);
                    liff.closeWindow();
                } else {
                    alert('é ç´„å¤±æ•—: ' + result.message);
                    btn.disabled = false;
                    btn.innerText = 'é€å‡ºé ç´„';
                }
            })
            .catch(err => {
                alert('é€£ç·šéŒ¯èª¤: ' + err);
                btn.disabled = false;
                btn.innerText = 'é€å‡ºé ç´„';
            });
        }
    </script>
</body>
</html>

