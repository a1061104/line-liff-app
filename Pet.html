<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯›å°å­©è³‡æ–™ç¶­è­·</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f5f5f5; padding: 15px; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h3 { text-align: center; color: #333; margin-top: 0; margin-bottom: 20px; }
        
        .section-title { background-color: #06c755; color: white; padding: 10px 15px; border-radius: 5px; margin: 25px 0 15px 0; font-weight: bold; font-size: 16px; }
        .section-title:first-of-type { margin-top: 0; }
        
        .pet-controls { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px; background-color: #e8f5e9; padding: 15px; border-radius: 8px; border: 1px solid #c8e6c9; }
        .pet-select-wrapper { flex-grow: 1; }
        .pet-select-wrapper label { font-weight: bold; color: #2e7d32; display: block; margin-bottom: 5px; font-size: 14px; }
        .btn-add-new { flex-shrink: 0; background-color: #ff9800; color: white; border: none; padding: 10px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; height: 44px; display: flex; align-items: center; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: #555; }
        
        .form-control, .form-select { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; 
            box-sizing: border-box; font-size: 16px; background-color: #fff; height: 44px; line-height: 1.2; 
            -webkit-appearance: none; appearance: none;
        }
        
        .readonly-field { background-color: #f0f0f0 !important; color: #666; cursor: not-allowed; }

        .disease-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #eee; box-sizing: border-box;}
        .checkbox-item input { margin-right: 10px; width: 20px; height: 20px; flex-shrink: 0; }
        
        .memo-container { grid-column: span 2; border: 1px solid #eee; padding: 12px; border-radius: 8px; background: #fff; }
        .memo-header { display: flex; align-items: center; margin-bottom: 8px; }
        .memo-header input { margin-right: 10px; width: 20px; height: 20px; }
        .memo-input { width: 85%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; display: block; margin-left: 30px; box-sizing: border-box; }

        .btn-submit { width: 100%; padding: 14px; background-color: #06c755; color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 30px; box-shadow: 0 4px 6px rgba(6,199,85,0.2); }
        
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; font-weight: bold; color: #06c755; }
        #mode-label { font-size: 13px; color: #666; text-align: right; margin-bottom: 10px; display: none;}
    </style>
</head>
<body>

    <div id="loading-mask"><div>è³‡æ–™è®€å–ä¸­...</div></div>

    <div class="container">
        <h3>ğŸ¶ æ¯›å°å­©è³‡æ–™ç¶­è­· ğŸ±</h3>
        
        <div class="pet-controls">
            <div class="pet-select-wrapper">
                <label>ç¶­è­·æ—¢æœ‰å¯µç‰©ï¼š</label>
                <select id="pet-select" class="form-select" onchange="onPetSelectChange()">
                    <option value="" disabled selected>ğŸ”½ è®€å–ä¸­...</option>
                </select>
            </div>
            <button class="btn-add-new" onclick="switchToNewPetMode()">â• æ–°å¢</button>
        </div>
        <div id="mode-label">ç›®å‰æ¨¡å¼ï¼š<span id="current-mode-text" style="font-weight:bold;">ç¶­è­·æ¨¡å¼</span></div>

        <div id="pet-form">
            <div class="section-title">ğŸ“‚ åŸºæœ¬è³‡æ–™</div>
            <input type="hidden" id="current_p_id" value="">
            
            <div class="form-group"><label>å¯µç‰©åç¨± <span style="color:red">*</span></label><input type="text" id="p_name" class="form-control" placeholder="è«‹è¼¸å…¥å¯µç‰©å§“å"></div>
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;"><label>ç¨®é¡</label><select id="p_type" class="form-select"><option value="1">ğŸ¶ ç‹—</option><option value="2">ğŸ± è²“</option></select></div>
                <div style="flex:1;"><label>æ€§åˆ¥</label><select id="p_sex" class="form-select"><option value="B">ğŸš¹ ç”·ç”Ÿ</option><option value="G">ğŸšº å¥³ç”Ÿ</option></select></div>
            </div>
            <div class="form-group"><label>å“ç¨® <span style="color:red">*</span></label><select id="p_breeds" class="form-select"><option value="">è«‹é¸æ“‡å“ç¨®</option></select></div>
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;"><label>é«”é‡ (KG)</label><input type="number" id="p_weight" class="form-control" step="0.1" placeholder="0.0" oninput="autoCalcSize()"></div>
                <div style="flex:1;"><label>é«”å‹ (è‡ªå‹•åˆ¤å®š)</label><input type="text" id="p_size_display" class="form-control readonly-field" readonly placeholder="å¾…è¼¸å…¥é«”é‡"></div>
            </div>
            <div class="form-group"><label>ç”Ÿæ—¥</label><input type="date" id="p_birthday" class="form-control"></div>
            <div class="form-group"><label>æ™¶ç‰‡è™Ÿç¢¼</label><input type="text" id="p_ic" class="form-control" placeholder="è‹¥ç„¡å¯ä¸å¡«"></div>
            <div class="form-group"><label>å‚™è¨»</label><textarea id="p_memo" class="form-control" style="height:60px;" placeholder="å…¶ä»–æƒ³è¦å‘ŠçŸ¥çš„äº‹é …..."></textarea></div>

            <div class="section-title">ğŸ¥ å¥åº·ç‹€æ³</div>
            <button id="btn-save" class="btn-submit" onclick="savePet()">ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <script>
        const MY_LIFF_ID = '2008965576-txfwY86y'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxzciNP_1cdq9XBnfcgTj5gv_QEt2xk-cevUsocHJx5j4IxjhJvS9DHHz1hhPXzDQHl/exec';
        let currentUserId = '', allBreedsData = [];

        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                loadBreedData().then(() => {
                    if (!liff.isLoggedIn()) { liff.login(); } 
                    else { liff.getProfile().then(profile => { currentUserId = profile.userId; loadPetList(); }); }
                });
            });
        };

        // ... çœç•¥ autoCalcSize, loadBreedData, renderBreedsOptions, loadPetList, loadPetDetail ç­‰è¼”åŠ©å‡½å¼ ...

        function savePet() {
            const name = document.getElementById('p_name').value, breeds = document.getElementById('p_breeds').value;
            if (!name || !breeds) { 
                Swal.fire({ icon: 'warning', title: 'ç¼ºå°‘è³‡æ–™', text: 'è«‹å¡«å¯«å¿…å¡«æ¬„ä½ (åç¨±èˆ‡å“ç¨®)' });
                return; 
            }
            
            const btn = document.getElementById('btn-save'); btn.disabled = true; btn.innerText = 'å„²å­˜ä¸­...';
            
            // è®€å–æ‰€æœ‰è¡¨å–®æ•¸å€¼
            const getC = (id) => document.getElementById(id).checked ? 1 : 0, getV = (id) => document.getElementById(id).value.trim();
            const sC = ['ps_ckd','ps_rv','ps_hi','ps_vi','ps_hwd','ps_gi','ps_cdv','ps_piv','ps_dl','ps_ntds','ps_oa','ps_ad','ps_other'];
            const sM = ['ps_dl_memo','ps_ntds_memo','ps_oa_memo','ps_ad_memo','ps_other_memo'];
            const wC = ['pw_asb','pw_wn','pw_mani','pw_sad','pw_dds','pw_pd','pw_bwa','pw_other'];
            const wM = ['pw_bwa_memo','pw_other_memo'];
            const anyS = sC.some(id => getC(id) === 1); const anyW = wC.some(id => getC(id) === 1);
            
            let params = `?action=pet_save&u_id=${encodeURIComponent(currentUserId)}&p_id=${document.getElementById('current_p_id').value}&p_name=${encodeURIComponent(name)}&p_type=${document.getElementById('p_type').value}&p_sex=${document.getElementById('p_sex').value}&p_breeds=${encodeURIComponent(breeds)}&p_weight=${getV('p_weight')}&p_birthday=${getV('p_birthday')}&p_ic=${encodeURIComponent(getV('p_ic'))}&p_memo=${encodeURIComponent(getV('p_memo'))}`;
            params += `&ps_none=${(!anyS?1:getC('ps_none'))}`; sC.forEach(id => params += `&${id}=${getC(id)}`); sM.forEach(id => params += `&${id}=${encodeURIComponent(getV(id))}`);
            params += `&pw_none=${(!anyW?1:getC('pw_none'))}`; wC.forEach(id => params += `&${id}=${getC(id)}`); wM.forEach(id => params += `&${id}=${encodeURIComponent(getV(id))}`);

            fetch(GAS_URL + params).then(res => res.json()).then(result => { 
                if (result.status === 'success') { 
                    Swal.fire({ 
                        icon: 'success', 
                        title: 'å„²å­˜æˆåŠŸï¼', 
                        showConfirmButton: false, 
                        timer: 1500 
                    }).then(() => { 
                        // âœ… ä¿®æ”¹é»ï¼šå­˜æª”æˆåŠŸä¸¦æç¤ºå¾Œï¼Œé—œé–‰ LIFF è¦–çª—å›åˆ° LINE
                        if (liff.isInClient()) {
                            liff.closeWindow(); 
                        } else {
                            // è‹¥åœ¨ä¸€èˆ¬ç€è¦½å™¨æ¸¬è©¦ï¼Œå‰‡è·³è½‰å›é¦–é 
                            window.location.href = GAS_URL;
                        }
                    });
                } 
            }).catch(err => { 
                Swal.fire({ icon: 'error', title: 'é€£ç·šå¤±æ•—', text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š' });
                btn.disabled = false; btn.innerText = 'ç¢ºèªå„²å­˜'; 
            });
        }

        // ... çœç•¥å…¶é¤˜æ¨¡å¼åˆ‡æ›èˆ‡äº‹ä»¶å‡½å¼ ...
    </script>
</body>
</html>
