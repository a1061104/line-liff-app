<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯µç‰©è³‡æ–™å»ºæª”</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f5f5f5; padding: 15px; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h3 { text-align: center; color: #333; margin-top: 0; }

        /* ä¿®æ”¹å¾Œçš„é ‚éƒ¨æ“ä½œå€ (Flexbox æ’ç‰ˆ) */
        .pet-controls {
            display: flex;
            gap: 10px;
            align-items: flex-end; /* å°é½Šåº•éƒ¨ */
            margin-bottom: 20px;
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c8e6c9;
        }
        
        .pet-select-wrapper {
            flex-grow: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
        }
        .pet-select-wrapper label { font-weight: bold; color: #2e7d32; display: block; margin-bottom: 5px; font-size: 14px; }
        
        .btn-add-new {
            flex-shrink: 0; /* ä¸å£“ç¸® */
            background-color: #ff9800; /* æ©˜è‰²æŒ‰éˆ•å€åˆ† */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            height: 44px; /* èˆ‡è¼¸å…¥æ¡†ç­‰é«˜ */
            display: flex;
            align-items: center;
        }

        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #666; font-weight: bold; }
        .tab.active { color: #06c755; border-bottom: 2px solid #06c755; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: #555; }
        
        .form-control, .form-select { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; 
            box-sizing: border-box; font-size: 16px; background-color: #fff;
            -webkit-appearance: none; appearance: none;
            height: 44px;
        }
        input[type="date"].form-control { line-height: 1.4; display: block; }
        
        .checkbox-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #eee; }
        .checkbox-item input { margin-right: 10px; width: 20px; height: 20px; }
        
        .btn { width: 100%; padding: 14px; background-color: #06c755; color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn:disabled { background-color: #ccc; }
        
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        #mode-label { font-size: 12px; color: #666; text-align: right; margin-top: -15px; margin-bottom: 10px; display: none;}
    </style>
</head>
<body>

    <div id="loading-mask"><div>è³‡æ–™è®€å–ä¸­...</div></div>

    <div class="container">
        <h3>ğŸ¶ å¯µç‰©è³‡æ–™ç®¡ç† ğŸ±</h3>
        
        <div class="pet-controls">
            <div class="pet-select-wrapper">
                <label>ç¶­è­·æ—¢æœ‰å¯µç‰©ï¼š</label>
                <select id="pet-select" class="form-select" onchange="onPetSelectChange()">
                    <option value="">(è®€å–ä¸­...)</option>
                </select>
            </div>
            <button class="btn-add-new" onclick="switchToNewPetMode()">
                â• æ–°å¢
            </button>
        </div>
        <div id="mode-label">ç›®å‰æ¨¡å¼ï¼š<span id="current-mode-text" style="font-weight:bold; color:#06c755;">ç·¨è¼¯ä¸­</span></div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('basic')">åŸºæœ¬è³‡æ–™</div>
            <div class="tab" onclick="switchTab('sick')">å¥åº·ç‹€æ³</div>
            <div class="tab" onclick="switchTab('wariness')">æ³¨æ„äº‹é …</div>
        </div>

        <div id="tab-basic" class="tab-content active">
            <input type="hidden" id="current_p_id" value="">

            <div class="form-group">
                <label>å¯µç‰©åç¨±</label>
                <input type="text" id="p_name" class="form-control" placeholder="ä¾‹å¦‚ï¼šå°ç™½">
            </div>
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>ç¨®é¡</label>
                    <select id="p_type" class="form-select">
                        <option value="1">ğŸ¶ ç‹—</option>
                        <option value="2">ğŸ± è²“</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label>æ€§åˆ¥</label>
                    <select id="p_sex" class="form-select">
                        <option value="B">ğŸš¹ ç”·ç”Ÿ</option>
                        <option value="G">ğŸšº å¥³ç”Ÿ</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>é«”é‡ (KG)</label>
                <input type="number" id="p_weight" class="form-control" placeholder="ä¾‹å¦‚ï¼š5.5" step="0.1">
            </div>

            <div class="form-group">
                <label>å“ç¨®</label>
                <input type="text" id="p_breeds" class="form-control" placeholder="ä¾‹å¦‚ï¼šæŸ´çŠ¬">
            </div>
            <div class="form-group">
                <label>ç”Ÿæ—¥</label>
                <input type="date" id="p_birthday" class="form-control">
            </div>
            <div class="form-group">
                <label>æ™¶ç‰‡è™Ÿç¢¼</label>
                <input type="text" id="p_ic" class="form-control" placeholder="è¼¸å…¥æ™¶ç‰‡è™Ÿç¢¼">
            </div>
            <div class="form-group">
                <label>å‚™è¨»</label>
                <textarea id="p_memo" class="form-control" style="height:60px;"></textarea>
            </div>
        </div>

        <div id="tab-sick" class="tab-content">
            <div class="form-group">
                <label style="color:#e74c3c;">æ˜¯å¦æœ‰ä»¥ä¸‹ç—…å²ï¼Ÿ(å¯è¤‡é¸)</label>
                <div class="checkbox-item" style="margin-bottom:10px;">
                    <input type="checkbox" id="ps_healthy" onchange="toggleHealthy(this)">
                    <label for="ps_healthy" style="margin:0; width:100%;">âœ… å¥åº·ç„¡ç–¾ç—…</label>
                </div>
                <div class="checkbox-group" id="sick-list">
                    <div class="checkbox-item"><input type="checkbox" id="ps_ckd"><label for="ps_ckd">æ…¢æ€§è…è¡°</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_ntds"><label for="ps_ntds">å¯„ç”ŸèŸ²</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_rv"><label for="ps_rv">ç‹‚çŠ¬ç—…</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_oa"><label for="ps_oa">éª¨éª¼èˆŠå‚·</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_dl"><label for="ps_dl">é—œç¯€è„«è‡¼</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_hi"><label for="ps_hi">è½åŠ›å—æ</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_vi"><label for="ps_vi">è¦–åŠ›å—æ</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_hwd"><label for="ps_hwd">å¿ƒçµ²èŸ²</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_gi"><label for="ps_gi">ç—…æ¯’è…¸ç‚</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_cdv"><label for="ps_cdv">çŠ¬ç˜Ÿç†±</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_piv"><label for="ps_piv">å‰¯æµæ„Ÿ</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_ad"><label for="ps_ad">çš®è†šç—…</label></div>
                </div>
                <div class="form-group" style="margin-top:10px;">
                    <label>å…¶ä»–ç–¾ç—…</label>
                    <input type="text" id="ps_other" class="form-control">
                </div>
            </div>
        </div>

        <div id="tab-wariness" class="tab-content">
            <div class="form-group">
                <label style="color:#e67e22;">ç¾å®¹/ä½å®¿æ³¨æ„äº‹é … (å¯è¤‡é¸)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="pw_asb"><label for="pw_asb">å…·æ”»æ“Šæ€§</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_wn"><label for="pw_wn">æ€•å¹é¢¨æ©Ÿ</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_mani"><label for="pw_mani">æ€•å‰ªæŒ‡ç”²</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_sad"><label for="pw_sad">åˆ†é›¢ç„¦æ…®</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_dds"><label for="pw_dds">æ˜“æ™æ‰</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_pd"><label for="pw_pd">ä¸è¦ªäºº</label></div>
                </div>
                <div class="form-group" style="margin-top:10px;">
                    <label>æ•æ„Ÿéƒ¨ä½ (å¦‚ï¼šå°¾å·´ã€è€³æœµ)</label>
                    <input type="text" id="pw_bwa" class="form-control">
                </div>
                <div class="form-group">
                    <label>å…¶ä»–æ³¨æ„äº‹é …</label>
                    <input type="text" id="pw_other" class="form-control">
                </div>
            </div>
            
            <button id="btn-save" class="btn" onclick="savePet()">ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <script>
        const MY_LIFF_ID = '2008965576-txfwY86y'; 
        // è«‹ç¢ºèªé€™æ˜¯æ‚¨çš„ GAS ç¶²å€
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzteHr3C5uweBFj6FQCUtQfEEyDQpf7EIkb0vUuoiEmnPLgc37G894IbGNgvI3-5iYISg/exec';

        let currentUserId = '';

        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    liff.getProfile().then(profile => {
                        currentUserId = profile.userId;
                        loadPetList(); // ç™»å…¥å¾Œè¼‰å…¥åˆ—è¡¨
                    });
                }
            });
        };

        // 1. è¼‰å…¥å¯µç‰©åˆ—è¡¨ (è‡ªå‹•é¸æ“‡ç¬¬ä¸€éš»)
        function loadPetList() {
            fetch(GAS_URL + `?action=pet_query_list&u_id=${encodeURIComponent(currentUserId)}`)
            .then(res => res.json())
            .then(result => {
                document.getElementById('loading-mask').style.display = 'none';
                if (result.status === 'success') {
                    const select = document.getElementById('pet-select');
                    select.innerHTML = ''; // æ¸…ç©ºé¸é …
                    
                    if (result.data.length > 0) {
                        // æœ‰å¯µç‰©ï¼šå¡«å…¥é¸é …ä¸¦è‡ªå‹•é¸ç¬¬ä¸€éš»
                        result.data.forEach(pet => {
                            let option = document.createElement('option');
                            option.value = pet.p_id;
                            option.text = `ğŸ¶ ${pet.p_name}`;
                            select.appendChild(option);
                        });
                        
                        // ã€é—œéµã€‘è‡ªå‹•è¼‰å…¥ç¬¬ä¸€éš»å¯µç‰©çš„è³‡æ–™
                        select.selectedIndex = 0;
                        loadPetDetail(result.data[0].p_id);
                        updateModeLabel(false); // é¡¯ç¤ºç‚ºç·¨è¼¯æ¨¡å¼
                    } else {
                        // æ²’å¯µç‰©ï¼šè‡ªå‹•åˆ‡æ›åˆ°æ–°å¢æ¨¡å¼
                        let option = document.createElement('option');
                        option.text = "(å°šç„¡å¯µç‰©è³‡æ–™)";
                        select.appendChild(option);
                        select.disabled = true; // é–å®šä¸‹æ‹‰é¸å–®
                        switchToNewPetMode();
                    }
                }
            });
        }

        // 2. åˆ‡æ›è‡³ã€Œæ–°å¢æ¨¡å¼ã€ (æŒ‰éˆ•è§¸ç™¼)
        function switchToNewPetMode() {
            // è¦–è¦ºä¸Šçš„è™•ç†
            document.getElementById('pet-select').value = ""; // å–æ¶ˆä¸‹æ‹‰é¸å–®é¸å–ç‹€æ…‹ (è‹¥æœ‰)
            
            // æ’å…¥ä¸€å€‹æš«æ™‚çš„ã€Œæ–°å¢ä¸­ã€é¸é …ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“ç¾åœ¨ä¸åœ¨ç·¨è¼¯èˆŠè³‡æ–™
            const select = document.getElementById('pet-select');
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ "new_temp" é¸é …ï¼Œé¿å…é‡è¤‡åŠ 
            if (!select.querySelector('option[value="new_temp"]')) {
                 let option = document.createElement('option');
                 option.value = "new_temp";
                 option.text = "â• æ­£åœ¨æ–°å¢å¯µç‰©...";
                 option.selected = true;
                 select.appendChild(option);
            }
            select.value = "new_temp";

            resetForm();
            updateModeLabel(true); // é¡¯ç¤ºç‚ºæ–°å¢æ¨¡å¼
            // å¯é¸æ“‡æ€§è·³å‡ºæç¤º
            // alert('å·²åˆ‡æ›è‡³ã€Œæ–°å¢æ¨¡å¼ã€ï¼Œè«‹è¼¸å…¥æ–°å¯µç‰©è³‡æ–™ã€‚');
        }

        // 3. é¸æ“‡æ—¢æœ‰å¯µç‰© (ä¸‹æ‹‰é¸å–®è§¸ç™¼)
        function onPetSelectChange() {
            const petId = document.getElementById('pet-select').value;
            // æ’é™¤ "new_temp" æˆ–ç©ºå€¼
            if (petId && petId !== "new_temp") {
                loadPetDetail(petId);
                updateModeLabel(false);
            } else if (petId === "new_temp") {
                switchToNewPetMode();
            }
        }

        function updateModeLabel(isNew) {
            const labelDiv = document.getElementById('mode-label');
            const textSpan = document.getElementById('current-mode-text');
            labelDiv.style.display = 'block';
            if (isNew) {
                textSpan.innerText = 'æ–°å¢æ¨¡å¼';
                textSpan.style.color = '#ff9800';
                document.getElementById('btn-save').innerText = 'ç¢ºèªæ–°å¢';
            } else {
                textSpan.innerText = 'ç¶­è­·æ¨¡å¼';
                textSpan.style.color = '#06c755';
                document.getElementById('btn-save').innerText = 'å„²å­˜ä¿®æ”¹';
            }
        }

        function loadPetDetail(petId) {
            document.getElementById('loading-mask').style.display = 'flex';
            
            fetch(GAS_URL + `?action=pet_query_detail&p_id=${petId}`)
            .then(res => res.json())
            .then(result => {
                document.getElementById('loading-mask').style.display = 'none';
                if (result.status === 'success') {
                    const d = result.data;
                    document.getElementById('current_p_id').value = petId;
                    
                    if(d.basic) {
                        document.getElementById('p_name').value = d.basic.p_name;
                        document.getElementById('p_type').value = d.basic.p_type;
                        document.getElementById('p_sex').value = d.basic.p_sex;
                        document.getElementById('p_weight').value = d.basic.p_weight; 
                        document.getElementById('p_breeds').value = d.basic.p_breeds;
                        document.getElementById('p_birthday').value = d.basic.p_birthday;
                        document.getElementById('p_ic').value = d.basic.p_ic;
                        document.getElementById('p_memo').value = d.basic.p_memo;
                    }

                    if(d.sick) {
                        const setCheck = (id, val) => {
                            document.getElementById(id).checked = (val == 1);
                        };
                        setCheck('ps_healthy', d.sick.ps_healthy);
                        toggleHealthy(document.getElementById('ps_healthy'));

                        setCheck('ps_ckd', d.sick.ps_ckd); setCheck('ps_ntds', d.sick.ps_ntds);
                        setCheck('ps_rv', d.sick.ps_rv); setCheck('ps_oa', d.sick.ps_oa);
                        setCheck('ps_dl', d.sick.ps_dl); setCheck('ps_hi', d.sick.ps_hi);
                        setCheck('ps_vi', d.sick.ps_vi); setCheck('ps_hwd', d.sick.ps_hwd);
                        setCheck('ps_gi', d.sick.ps_gi); setCheck('ps_cdv', d.sick.ps_cdv);
                        setCheck('ps_piv', d.sick.ps_piv); setCheck('ps_ad', d.sick.ps_ad);
                        document.getElementById('ps_other').value = d.sick.ps_other;
                    }

                    if(d.wariness) {
                        const setCheck = (id, val) => { document.getElementById(id).checked = (val == 1); };
                        setCheck('pw_asb', d.wariness.pw_asb); setCheck('pw_wn', d.wariness.pw_wn);
                        setCheck('pw_mani', d.wariness.pw_mani); setCheck('pw_sad', d.wariness.pw_sad);
                        setCheck('pw_dds', d.wariness.pw_dds); setCheck('pw_pd', d.wariness.pw_pd);
                        document.getElementById('pw_bwa').value = d.wariness.pw_bwa;
                        document.getElementById('pw_other').value = d.wariness.pw_other;
                    }
                    
                    // åˆ‡æ›å›åŸºæœ¬è³‡æ–™åˆ†é ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°è³‡æ–™è®Šäº†
                    switchTab('basic');
                }
            });
        }

        function resetForm() {
            document.getElementById('current_p_id').value = ''; // æ¸…ç©º ID
            document.querySelectorAll('input[type=text], input[type=date], input[type=number], textarea').forEach(el => el.value = '');
            document.querySelectorAll('input[type=checkbox]').forEach(el => {
                el.checked = false;
                el.disabled = false;
            });
            document.getElementById('p_type').value = '1';
            document.getElementById('p_sex').value = 'B';
            switchTab('basic');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if(tabName === 'basic') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('tab-basic').classList.add('active');
            } else if(tabName === 'sick') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('tab-sick').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                document.getElementById('tab-wariness').classList.add('active');
            }
        }

        function toggleHealthy(checkbox) {
            const sickCheckboxes = document.querySelectorAll('#sick-list input[type="checkbox"]');
            if (checkbox.checked) {
                sickCheckboxes.forEach(el => { el.checked = false; el.disabled = true; });
            } else {
                sickCheckboxes.forEach(el => { el.disabled = false; });
            }
        }

        function savePet() {
            const name = document.getElementById('p_name').value;
            if (!name) { alert('è«‹è¼¸å…¥å¯µç‰©åç¨±'); switchTab('basic'); return; }

            const btn = document.getElementById('btn-save');
            btn.disabled = true;
            btn.innerText = 'è³‡æ–™å„²å­˜ä¸­...';

            const p_id = document.getElementById('current_p_id').value;

            let params = `?action=pet_save&u_id=${encodeURIComponent(currentUserId)}`;
            params += `&p_id=${p_id}`;
            
            params += `&p_name=${encodeURIComponent(name)}`;
            params += `&p_type=${document.getElementById('p_type').value}`;
            params += `&p_sex=${document.getElementById('p_sex').value}`;
            params += `&p_weight=${encodeURIComponent(document.getElementById('p_weight').value)}`;
            params += `&p_breeds=${encodeURIComponent(document.getElementById('p_breeds').value)}`;
            params += `&p_birthday=${document.getElementById('p_birthday').value}`;
            params += `&p_ic=${encodeURIComponent(document.getElementById('p_ic').value)}`;
            params += `&p_memo=${encodeURIComponent(document.getElementById('p_memo').value)}`;

            const getCheck = (id) => document.getElementById(id).checked ? 1 : 0;
            params += `&ps_healthy=${getCheck('ps_healthy')}`;
            params += `&ps_ckd=${getCheck('ps_ckd')}&ps_ntds=${getCheck('ps_ntds')}&ps_rv=${getCheck('ps_rv')}`;
            params += `&ps_oa=${getCheck('ps_oa')}&ps_dl=${getCheck('ps_dl')}&ps_hi=${getCheck('ps_hi')}`;
            params += `&ps_vi=${getCheck('ps_vi')}&ps_hwd=${getCheck('ps_hwd')}&ps_gi=${getCheck('ps_gi')}`;
            params += `&ps_cdv=${getCheck('ps_cdv')}&ps_piv=${getCheck('ps_piv')}&ps_ad=${getCheck('ps_ad')}`;
            params += `&ps_other=${encodeURIComponent(document.getElementById('ps_other').value)}`;

            params += `&pw_asb=${getCheck('pw_asb')}&pw_wn=${getCheck('pw_wn')}&pw_mani=${getCheck('pw_mani')}`;
            params += `&pw_sad=${getCheck('pw_sad')}&pw_dds=${getCheck('pw_dds')}&pw_pd=${getCheck('pw_pd')}`;
            params += `&pw_bwa=${encodeURIComponent(document.getElementById('pw_bwa').value)}`;
            params += `&pw_other=${encodeURIComponent(document.getElementById('pw_other').value)}`;

            fetch(GAS_URL + params)
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success') {
                        alert(`å„²å­˜æˆåŠŸï¼`);
                        location.reload(); 
                    } else {
                        alert('å­˜æª”å¤±æ•—: ' + result.message);
                        btn.disabled = false;
                        btn.innerText = 'ç¢ºèªå„²å­˜';
                    }
                })
                .catch(err => {
                    alert('é€£ç·šéŒ¯èª¤: ' + err);
                    btn.disabled = false;
                    btn.innerText = 'ç¢ºèªå„²å­˜';
                });
        }
    </script>
</body>
</html>
