<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯µç‰©è³‡æ–™å»ºæª”</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f5f5f5; padding: 15px; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h3 { text-align: center; color: #333; margin-top: 0; }
        .pet-controls { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px; background-color: #e8f5e9; padding: 15px; border-radius: 8px; border: 1px solid #c8e6c9; }
        .pet-select-wrapper { flex-grow: 1; position: relative; }
        .pet-select-wrapper label { font-weight: bold; color: #2e7d32; display: block; margin-bottom: 5px; font-size: 14px; }
        .btn-add-new { flex-shrink: 0; background-color: #ff9800; color: white; border: none; padding: 10px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; height: 44px; display: flex; align-items: center; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #666; font-weight: bold; }
        .tab.active { color: #06c755; border-bottom: 2px solid #06c755; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: #555; }
        .form-control, .form-select { width: 100%; padding: 0 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; background-color: #fff; height: 44px; line-height: 42px; appearance: none; -webkit-appearance: none; }
        .form-select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; color: #333; }
        
        /* ç–¾ç—…èˆ‡æ³¨æ„äº‹é …æ’åˆ— */
        .disease-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #eee; height: 100%; box-sizing: border-box;}
        .checkbox-item input { margin-right: 10px; width: 20px; height: 20px; flex-shrink: 0; }
        .memo-input { width: 100%; margin-top: 5px; padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }

        .btn { width: 100%; padding: 14px; background-color: #06c755; color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; }
        #mode-label { font-size: 12px; color: #666; text-align: right; margin-top: -15px; margin-bottom: 10px; display: none;}
    </style>
</head>
<body>

    <div id="loading-mask"><div>è³‡æ–™è®€å–ä¸­...</div></div>

    <div class="container">
        <h3>ğŸ¶ å¯µç‰©è³‡æ–™ç®¡ç† ğŸ±</h3>
        
        <div class="pet-controls">
            <div class="pet-select-wrapper">
                <label>ç¶­è­·æ—¢æœ‰å¯µç‰©ï¼š</label>
                <select id="pet-select" class="form-select" onchange="onPetSelectChange()">
                    <option value="" disabled selected>ğŸ”½ è®€å–ä¸­...</option>
                </select>
            </div>
            <button class="btn-add-new" onclick="switchToNewPetMode()">â• æ–°å¢</button>
        </div>
        <div id="mode-label">ç›®å‰æ¨¡å¼ï¼š<span id="current-mode-text" style="font-weight:bold; color:#06c755;">ç·¨è¼¯ä¸­</span></div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('basic')">åŸºæœ¬è³‡æ–™</div>
            <div class="tab" onclick="switchTab('sick')">å¥åº·ç‹€æ³</div>
            <div class="tab" onclick="switchTab('wariness')">æ³¨æ„äº‹é …</div>
        </div>

        <div id="tab-basic" class="tab-content active">
            <input type="hidden" id="current_p_id" value="">
            <div class="form-group"><label>å¯µç‰©åç¨± <span style="color:red">*</span></label><input type="text" id="p_name" class="form-control"></div>
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;"><label>ç¨®é¡</label><select id="p_type" class="form-select"><option value="1">ğŸ¶ ç‹—</option><option value="2">ğŸ± è²“</option></select></div>
                <div style="flex:1;"><label>æ€§åˆ¥</label><select id="p_sex" class="form-select"><option value="B">ğŸš¹ ç”·ç”Ÿ</option><option value="G">ğŸšº å¥³ç”Ÿ</option></select></div>
            </div>
            <div class="form-group"><label>å“ç¨® <span style="color:red">*</span></label><select id="p_breeds" class="form-select"><option value="">è®€å–ä¸­...</option></select></div>
            <div class="form-group"><label>é«”é‡ (KG)</label><input type="number" id="p_weight" class="form-control" step="0.1"></div>
            <div class="form-group"><label>ç”Ÿæ—¥</label><input type="date" id="p_birthday" class="form-control"></div>
            <div class="form-group"><label>æ™¶ç‰‡è™Ÿç¢¼</label><input type="text" id="p_ic" class="form-control"></div>
            <div class="form-group"><label>å‚™è¨»</label><textarea id="p_memo" class="form-control" style="height:60px;"></textarea></div>
        </div>

        <div id="tab-sick" class="tab-content">
            <div class="form-group">
                <label style="color:#e74c3c;">æ˜¯å¦æœ‰ä»¥ä¸‹ç—…å²ï¼Ÿ(å¯è¤‡é¸)</label>
                <div class="checkbox-item" style="margin-bottom:10px; background:#fff3e0;">
                    <input type="checkbox" id="ps_none" onchange="toggleHealthy(this)">
                    <label for="ps_none" style="margin:0; width:100%; font-weight:bold;">âœ… å¥åº·ç„¡ç–¾ç—… (PS_None)</label>
                </div>
                
                <div class="disease-grid" id="sick-list">
                    <div class="checkbox-item"><input type="checkbox" id="ps_ckd" onchange="onSickItemChange()"><label for="ps_ckd">æ…¢æ€§è…è¡°</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_rv" onchange="onSickItemChange()"><label for="ps_rv">ç‹‚çŠ¬ç—…</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_hi" onchange="onSickItemChange()"><label for="ps_hi">è½åŠ›å—æ</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_vi" onchange="onSickItemChange()"><label for="ps_vi">è¦–åŠ›å—æ</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_hwd" onchange="onSickItemChange()"><label for="ps_hwd">å¿ƒçµ²èŸ²</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_gi" onchange="onSickItemChange()"><label for="ps_gi">ç—…æ¯’è…¸ç‚</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_cdv" onchange="onSickItemChange()"><label for="ps_cdv">çŠ¬ç˜Ÿç†±</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ps_piv" onchange="onSickItemChange()"><label for="ps_piv">å‰¯æµæ„Ÿ</label></div>
                    
                    <div style="grid-column: span 2; border: 1px solid #eee; padding: 10px; border-radius: 5px;">
                        <input type="checkbox" id="ps_dl" onchange="onSickItemChange()"> <label for="ps_dl">é—œç¯€è„«è‡¼ (PS_DL)</label>
                        <input type="text" id="ps_dl_memo" class="memo-input" placeholder="è„«è‡¼éƒ¨ä½èªªæ˜..." oninput="onSickItemChange()">
                    </div>
                    <div style="grid-column: span 2; border: 1px solid #eee; padding: 10px; border-radius: 5px;">
                        <input type="checkbox" id="ps_ntds" onchange="onSickItemChange()"> <label for="ps_ntds">å¯„ç”ŸèŸ²æ„ŸæŸ“ (PS_NTDs)</label>
                        <input type="text" id="ps_ntds_memo" class="memo-input" placeholder="ç¨®é¡èªªæ˜..." oninput="onSickItemChange()">
                    </div>
                    <div style="grid-column: span 2; border: 1px solid #eee; padding: 10px; border-radius: 5px;">
                        <input type="checkbox" id="ps_oa" onchange="onSickItemChange()"> <label for="ps_oa">éª¨éª¼èˆŠå‚· (PS_OA)</label>
                        <input type="text" id="ps_oa_memo" class="memo-input" placeholder="èˆŠå‚·éƒ¨ä½èªªæ˜..." oninput="onSickItemChange()">
                    </div>
                    <div style="grid-column: span 2; border: 1px solid #eee; padding: 10px; border-radius: 5px;">
                        <input type="checkbox" id="ps_ad" onchange="onSickItemChange()"> <label for="ps_ad">çš®è†šç–¾ç—… (PS_AD)</label>
                        <input type="text" id="ps_ad_memo" class="memo-input" placeholder="ç‹€æ³èªªæ˜..." oninput="onSickItemChange()">
                    </div>
                    <div style="grid-column: span 2; border: 1px solid #eee; padding: 10px; border-radius: 5px;">
                        <input type="checkbox" id="ps_other" onchange="onSickItemChange()"> <label for="ps_other">å…¶ä»–ç—…å² (PS_Other)</label>
                        <input type="text" id="ps_other_memo" class="memo-input" placeholder="å…¶ä»–èªªæ˜..." oninput="onSickItemChange()">
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-wariness" class="tab-content">
            <div class="form-group">
                <label style="color:#e67e22;">ç¾å®¹/ä½å®¿æ³¨æ„äº‹é … (å¯è¤‡é¸)</label>
                <div class="checkbox-item" style="margin-bottom:10px; background:#fff3e0;">
                    <input type="checkbox" id="pw_none" onchange="toggleWariness(this)">
                    <label for="pw_none" style="margin:0; width:100%; font-weight:bold;">âœ… ç„¡é ˆæ³¨æ„äº‹é … (PW_None)</label>
                </div>
                <div class="disease-grid" id="wariness-list">
                    <div class="checkbox-item"><input type="checkbox" id="pw_asb" onchange="onWarinessItemChange()"><label for="pw_asb">å…·æ”»æ“Šæ€§</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_wn" onchange="onWarinessItemChange()"><label for="pw_wn">æ€•å¹é¢¨æ©Ÿ</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_mani" onchange="onWarinessItemChange()"><label for="pw_mani">æ€•å‰ªæŒ‡ç”²</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_sad" onchange="onWarinessItemChange()"><label for="pw_sad">åˆ†é›¢ç„¦æ…®</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_dds" onchange="onWarinessItemChange()"><label for="pw_dds">æ˜“æ™æ‰</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="pw_pd" onchange="onWarinessItemChange()"><label for="pw_pd">ä¸è¦ªäºº</label></div>
                    
                    <div style="grid-column: span 2; border: 1px solid #eee; padding: 10px; border-radius: 5px;">
                        <input type="checkbox" id="pw_bwa" onchange="onWarinessItemChange()"> <label for="pw_bwa">æ•æ„Ÿéƒ¨ä½ (PW_BWA)</label>
                        <input type="text" id="pw_bwa_memo" class="memo-input" placeholder="ä¾‹å¦‚ï¼šå°¾å·´ã€è€³æœµ..." oninput="onWarinessItemChange()">
                    </div>
                    <div style="grid-column: span 2; border: 1px solid #eee; padding: 10px; border-radius: 5px;">
                        <input type="checkbox" id="pw_other" onchange="onWarinessItemChange()"> <label for="pw_other">å…¶ä»–æ³¨æ„ (PW_Other)</label>
                        <input type="text" id="pw_other_memo" class="memo-input" placeholder="å…¶ä»–èªªæ˜..." oninput="onWarinessItemChange()">
                    </div>
                </div>
            </div>
            <button id="btn-save" class="btn" onclick="savePet()">ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <script>
        const MY_LIFF_ID = '2008965576-txfwY86y'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzteHr3C5uweBFj6FQCUtQfEEyDQpf7EIkb0vUuoiEmnPLgc37G894IbGNgvI3-5iYISg/exec';

        let currentUserId = '';
        let allBreedsData = [];

        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                loadBreedData().then(() => {
                    if (!liff.isLoggedIn()) { liff.login(); } 
                    else { liff.getProfile().then(profile => { currentUserId = profile.userId; loadPetList(); }); }
                });
            });
            document.getElementById('p_type').addEventListener('change', function() { renderBreedsOptions(); });
        };

        function loadBreedData() {
            return fetch(GAS_URL + `?action=pet_get_breeds`).then(res => res.json()).then(result => {
                if (result.status === 'success') { allBreedsData = result.data; renderBreedsOptions(); }
            });
        }

        function renderBreedsOptions(selectedValue = '') {
            const type = document.getElementById('p_type').value;
            const select = document.getElementById('p_breeds');
            select.innerHTML = '<option value="">è«‹é¸æ“‡å“ç¨®</option>';
            const filtered = allBreedsData.filter(item => item.code.toString().startsWith(type));
            filtered.forEach(item => {
                let option = document.createElement('option');
                option.value = item.name; option.text = item.name;
                select.appendChild(option);
            });
            if (selectedValue) select.value = selectedValue;
        }

        function loadPetList() {
            fetch(GAS_URL + `?action=pet_query_list&u_id=${encodeURIComponent(currentUserId)}`)
            .then(res => res.json()).then(result => {
                document.getElementById('loading-mask').style.display = 'none';
                const select = document.getElementById('pet-select');
                if (result.status === 'success') {
                    select.innerHTML = ''; 
                    let placeholder = new Option("ğŸ”½ è«‹é¸æ“‡æ¬²ä¿®æ”¹çš„å¯µç‰©...", "");
                    placeholder.disabled = true; select.add(placeholder);
                    if (result.data.length > 0) {
                        result.data.forEach(pet => { select.add(new Option(`ğŸ¶ ${pet.p_name}`, pet.p_id)); });
                        select.selectedIndex = 1; loadPetDetail(result.data[0].p_id); updateModeLabel(false);
                    } else { select.disabled = true; switchToNewPetMode(); }
                }
            });
        }

        function loadPetDetail(petId) {
            document.getElementById('loading-mask').style.display = 'flex';
            fetch(GAS_URL + `?action=pet_query_detail&p_id=${petId}`)
            .then(res => res.json()).then(result => {
                document.getElementById('loading-mask').style.display = 'none';
                if (result.status === 'success') {
                    const d = result.data;
                    document.getElementById('current_p_id').value = petId;
                    if(d.basic) {
                        document.getElementById('p_name').value = d.basic.p_name;
                        document.getElementById('p_type').value = d.basic.p_type;
                        renderBreedsOptions(d.basic.p_breeds);
                        document.getElementById('p_sex').value = d.basic.p_sex;
                        document.getElementById('p_weight').value = d.basic.p_weight;
                        document.getElementById('p_birthday').value = d.basic.p_birthday;
                        document.getElementById('p_ic').value = d.basic.p_ic;
                        document.getElementById('p_memo').value = d.basic.p_memo;
                    }
                    if(d.sick) {
                        const setCheck = (id, val) => { document.getElementById(id).checked = (val == 1); };
                        const setVal = (id, val) => { document.getElementById(id).value = val || ''; };
                        
                        setCheck('ps_none', d.sick.ps_none);
                        setCheck('ps_ckd', d.sick.ps_ckd); setCheck('ps_rv', d.sick.ps_rv);
                        setCheck('ps_hi', d.sick.ps_hi); setCheck('ps_vi', d.sick.ps_vi);
                        setCheck('ps_hwd', d.sick.ps_hwd); setCheck('ps_gi', d.sick.ps_gi);
                        setCheck('ps_cdv', d.sick.ps_cdv); setCheck('ps_piv', d.sick.ps_piv);
                        
                        setCheck('ps_dl', d.sick.ps_dl); setVal('ps_dl_memo', d.sick.ps_dl_memo);
                        setCheck('ps_ntds', d.sick.ps_ntds); setVal('ps_ntds_memo', d.sick.ps_ntds_memo);
                        setCheck('ps_oa', d.sick.ps_oa); setVal('ps_oa_memo', d.sick.ps_oa_memo);
                        setCheck('ps_ad', d.sick.ps_ad); setVal('ps_ad_memo', d.sick.ps_ad_memo);
                        setCheck('ps_other', d.sick.ps_other); setVal('ps_other_memo', d.sick.ps_other_memo);
                    }
                    if(d.wariness) {
                        const setCheck = (id, val) => { document.getElementById(id).checked = (val == 1); };
                        const setVal = (id, val) => { document.getElementById(id).value = val || ''; };
                        
                        setCheck('pw_none', d.wariness.pw_none);
                        setCheck('pw_asb', d.wariness.pw_asb); setCheck('pw_wn', d.wariness.pw_wn);
                        setCheck('pw_mani', d.wariness.pw_mani); setCheck('pw_sad', d.wariness.pw_sad);
                        setCheck('pw_dds', d.wariness.pw_dds); setCheck('pw_pd', d.wariness.pw_pd);
                        
                        setCheck('pw_bwa', d.wariness.pw_bwa); setVal('pw_bwa_memo', d.wariness.pw_bwa_memo);
                        setCheck('pw_other', d.wariness.pw_other); setVal('pw_other_memo', d.wariness.pw_other_memo);
                    }
                    switchTab('basic');
                }
            });
        }

        function toggleHealthy(checkbox) {
            if (checkbox.checked) {
                document.querySelectorAll('#sick-list input[type="checkbox"]').forEach(el => el.checked = false);
                document.querySelectorAll('#sick-list input[type="text"]').forEach(el => el.value = '');
            }
        }
        function onSickItemChange() { document.getElementById('ps_none').checked = false; }

        function toggleWariness(checkbox) {
            if (checkbox.checked) {
                document.querySelectorAll('#wariness-list input[type="checkbox"]').forEach(el => el.checked = false);
                document.querySelectorAll('#wariness-list input[type="text"]').forEach(el => el.value = '');
            }
        }
        function onWarinessItemChange() { document.getElementById('pw_none').checked = false; }

        function savePet() {
            const name = document.getElementById('p_name').value;
            const breeds = document.getElementById('p_breeds').value;
            if (!name || !breeds) { alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ (åç¨±èˆ‡å“ç¨®)'); return; }

            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.innerText = 'å„²å­˜ä¸­...';

            const getC = (id) => document.getElementById(id).checked ? 1 : 0;
            const getV = (id) => document.getElementById(id).value.trim();
            
            // è‡ªå‹•åˆ¤å®šã€Œç„¡ã€
            const sickChecks = ['ps_ckd','ps_rv','ps_hi','ps_vi','ps_hwd','ps_gi','ps_cdv','ps_piv','ps_dl','ps_ntds','ps_oa','ps_ad','ps_other'];
            const sickMemos = ['ps_dl_memo','ps_ntds_memo','ps_oa_memo','ps_ad_memo','ps_other_memo'];
            const anySick = sickChecks.some(id => getC(id) === 1) || sickMemos.some(id => getV(id) !== '');
            
            const warChecks = ['pw_asb','pw_wn','pw_mani','pw_sad','pw_dds','pw_pd','pw_bwa','pw_other'];
            const warMemos = ['pw_bwa_memo','pw_other_memo'];
            const anyWar = warChecks.some(id => getC(id) === 1) || warMemos.some(id => getV(id) !== '');

            let params = `?action=pet_save&u_id=${encodeURIComponent(currentUserId)}&p_id=${document.getElementById('current_p_id').value}`;
            params += `&p_name=${encodeURIComponent(name)}&p_type=${document.getElementById('p_type').value}&p_sex=${document.getElementById('p_sex').value}`;
            params += `&p_breeds=${encodeURIComponent(breeds)}&p_weight=${getV('p_weight')}&p_birthday=${getV('p_birthday')}`;
            params += `&p_ic=${encodeURIComponent(getV('p_ic'))}&p_memo=${encodeURIComponent(getV('p_memo'))}`;
            
            // ç–¾ç—…åƒæ•¸
            params += `&ps_none=${(!anySick ? 1 : getC('ps_none'))}`;
            sickChecks.forEach(id => params += `&${id}=${getC(id)}`);
            sickMemos.forEach(id => params += `&${id}=${encodeURIComponent(getV(id))}`);

            // æ³¨æ„äº‹é …åƒæ•¸
            params += `&pw_none=${(!anyWar ? 1 : getC('pw_none'))}`;
            warChecks.forEach(id => params += `&${id}=${getC(id)}`);
            warMemos.forEach(id => params += `&${id}=${encodeURIComponent(getV(id))}`);

            fetch(GAS_URL + params).then(res => res.json()).then(result => {
                if (result.status === 'success') { alert('å„²å­˜æˆåŠŸï¼'); location.reload(); }
            }).catch(err => { alert('é€£ç·šå¤±æ•—'); btn.disabled = false; btn.innerText = 'ç¢ºèªå„²å­˜'; });
        }

        function switchTab(t) {
            document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
            const idx = t==='basic'?1:t==='sick'?2:3;
            document.querySelector(`.tab:nth-child(${idx})`).classList.add('active');
            document.getElementById(`tab-${t}`).classList.add('active');
        }

        function switchToNewPetMode() {
            document.getElementById('current_p_id').value = '';
            document.querySelectorAll('input[type=text], input[type=date], input[type=number], textarea').forEach(el => el.value = '');
            document.querySelectorAll('input[type=checkbox]').forEach(el => el.checked = false);
            document.getElementById('pet-select').value = "";
            renderBreedsOptions();
            updateModeLabel(true);
            switchTab('basic');
        }

        function updateModeLabel(isNew) {
            const label = document.getElementById('mode-label');
            const text = document.getElementById('current-mode-text');
            label.style.display = 'block';
            text.innerText = isNew ? 'æ–°å¢æ¨¡å¼' : 'ç¶­è­·æ¨¡å¼';
            text.style.color = isNew ? '#ff9800' : '#06c755';
            document.getElementById('btn-save').innerText = isNew ? 'ç¢ºèªæ–°å¢' : 'å„²å­˜ä¿®æ”¹';
        }

        function onPetSelectChange() {
            const id = document.getElementById('pet-select').value;
            if (id) { loadPetDetail(id); updateModeLabel(false); }
        }
    </script>
</body>
</html>
