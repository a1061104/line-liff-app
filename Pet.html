<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯›å°å­©è³‡æ–™ç¶­è­·</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f5f5f5; padding: 15px; margin: 0; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h3 { text-align: center; color: #333; margin-top: 0; margin-bottom: 20px; }
        .section-title { background-color: #06c755; color: white; padding: 10px 15px; border-radius: 5px; margin: 25px 0 15px 0; font-weight: bold; font-size: 16px; }
        .pet-controls { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 20px; background-color: #e8f5e9; padding: 15px; border-radius: 8px; border: 1px solid #c8e6c9; }
        .pet-select-wrapper { flex-grow: 1; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: #555; }
        .form-control, .form-select { width: 100%; padding: 0 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; background-color: #fff; height: 44px; line-height: 42px; }
        .readonly-display { background-color: #f9f9f9; color: #06c755; font-weight: bold; border: 1px solid #ccc; display: flex; align-items: center; }
        .disease-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #eee; }
        .checkbox-item input { margin-right: 10px; width: 20px; height: 20px; }
        .memo-container { grid-column: span 2; border: 1px solid #eee; padding: 12px; border-radius: 8px; background: #fff; }
        .memo-input { width: 85%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; margin-left: 30px; box-sizing: border-box; }
        .btn-submit { width: 100%; padding: 14px; background-color: #06c755; color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 30px; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; font-weight: bold; color: #06c755; }
    </style>
</head>
<body>

    <div id="loading-mask"><div>è³‡æ–™è®€å–ä¸­...</div></div>

    <div class="container">
        <h3>ğŸ¶ æ¯›å°å­©è³‡æ–™ç¶­è­· ğŸ±</h3>
        
        <div class="pet-controls">
            <div class="pet-select-wrapper">
                <label>ç¶­è­·æ—¢æœ‰å¯µç‰©ï¼š</label>
                <select id="pet-select" class="form-select" onchange="onPetSelectChange()">
                    <option value="" disabled selected>ğŸ”½ è®€å–ä¸­...</option>
                </select>
            </div>
            <button class="btn-add-new" onclick="switchToNewPetMode()" style="background:#ff9800; color:white; border:none; padding:10px 15px; border-radius:5px; height:44px; cursor:pointer;">â• æ–°å¢</button>
        </div>

        <div id="pet-form">
            <div class="section-title">ğŸ“‚ åŸºæœ¬è³‡æ–™</div>
            <input type="hidden" id="current_p_id" value="">
            <div class="form-group"><label>å¯µç‰©åç¨± <span style="color:red">*</span></label><input type="text" id="p_name" class="form-control" placeholder="è«‹è¼¸å…¥å¯µç‰©å§“å"></div>
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;"><label>ç¨®é¡</label><select id="p_type" class="form-select"><option value="1">ğŸ¶ ç‹—</option><option value="2">ğŸ± è²“</option></select></div>
                <div style="flex:1;"><label>æ€§åˆ¥</label><select id="p_sex" class="form-select"><option value="B">ğŸš¹ ç”·ç”Ÿ</option><option value="G">ğŸšº å¥³ç”Ÿ</option></select></div>
            </div>
            <div class="form-group"><label>å“ç¨® <span style="color:red">*</span></label><select id="p_breeds" class="form-select"><option value="">è«‹é¸æ“‡å“ç¨®</option></select></div>
            
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>é«”é‡ (KG)</label>
                    <input type="number" id="p_weight" class="form-control" step="0.1" placeholder="0.0" oninput="updateSizeDisplay()">
                </div>
                <div style="flex:1;">
                    <label>é«”å‹</label>
                    <div id="p_size_text" class="form-control readonly-display">è‡ªå‹•åˆ¤å®š</div>
                </div>
            </div>

            <div class="form-group"><label>ç”Ÿæ—¥</label><input type="date" id="p_birthday" class="form-control"></div>
            <div class="form-group"><label>æ™¶ç‰‡è™Ÿç¢¼</label><input type="text" id="p_ic" class="form-control" placeholder="è‹¥ç„¡å¯ä¸å¡«"></div>
            <div class="form-group"><label>å‚™è¨»</label><textarea id="p_memo" class="form-control" style="height:60px;" placeholder="å…¶ä»–æƒ³è¦å‘ŠçŸ¥çš„äº‹é …..."></textarea></div>

            <div class="section-title">ğŸ¥ å¥åº·ç‹€æ³</div>
            <div class="checkbox-item" style="margin-bottom:12px; background:#fff3e0;"><input type="checkbox" id="ps_none" onchange="toggleHealthy(this)"><label for="ps_none">å¥åº·ç„¡ç–¾ç—…</label></div>
            <div class="disease-grid" id="sick-list">
                <div class="checkbox-item"><input type="checkbox" id="ps_ckd" onchange="onSickItemChange()"><label for="ps_ckd">æ…¢æ€§è…è¡°</label></div>
                <div class="checkbox-item"><input type="checkbox" id="ps_rv" onchange="onSickItemChange()"><label for="ps_rv">ç‹‚çŠ¬ç—…</label></div>
                <div class="memo-container"><div class="memo-header"><input type="checkbox" id="ps_dl" disabled><label>é—œç¯€è„«è‡¼</label></div><input type="text" id="ps_dl_memo" class="memo-input" oninput="updateLinkedCheckbox('ps_dl','ps_dl_memo','sick')"></div>
                <div class="memo-container"><div class="memo-header"><input type="checkbox" id="ps_other" disabled><label>å…¶ä»–ç—…å²</label></div><input type="text" id="ps_other_memo" class="memo-input" oninput="updateLinkedCheckbox('ps_other','ps_other_memo','sick')"></div>
            </div>

            <div class="section-title">âš ï¸ æ³¨æ„äº‹é …</div>
            <div class="checkbox-item" style="margin-bottom:12px; background:#fff3e0;"><input type="checkbox" id="pw_none" onchange="toggleWariness(this)"><label for="pw_none">ç„¡é ˆæ³¨æ„äº‹é …</label></div>
            <div class="disease-grid" id="wariness-list">
                <div class="checkbox-item"><input type="checkbox" id="pw_asb" onchange="onWarinessItemChange()"><label for="pw_asb">å…·æ”»æ“Šæ€§</label></div>
                <div class="memo-container"><div class="memo-header"><input type="checkbox" id="pw_other" disabled><label>å…¶ä»–æ³¨æ„</label></div><input type="text" id="pw_other_memo" class="memo-input" oninput="updateLinkedCheckbox('pw_other','pw_other_memo','war')"></div>
            </div>

            <button id="btn-save" class="btn-submit" onclick="savePet()">ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <script>
        const MY_LIFF_ID = '2008965576-txfwY86y'; 
        const GAS_URL = 'æ‚¨çš„GASéƒ¨ç½²ç¶²å€'; // ğŸš€ è«‹ç¢ºèªæ­¤è™•å·²å¡«å¯«
        let currentUserId = '', allBreedsData = [];

        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) { liff.login(); } 
                else { liff.getProfile().then(profile => { 
                    currentUserId = profile.userId; 
                    loadBreedData().then(loadPetList); 
                }); }
            });
            document.getElementById('p_type').addEventListener('change', function() { renderBreedsOptions(); });
        };

        // ğŸš€ å³æ™‚åˆ¤å®šé«”å‹é¡¯ç¤º
        function updateSizeDisplay() {
            const wVal = document.getElementById('p_weight').value;
            const sizeBox = document.getElementById('p_size_text');
            if (!wVal || isNaN(wVal)) { sizeBox.innerText = 'è‡ªå‹•åˆ¤å®š'; return; }
            const weight = parseFloat(wVal);
            if (weight <= 4) sizeBox.innerText = 'è¿·ä½ çŠ¬';
            else if (weight <= 10) sizeBox.innerText = 'å°å‹çŠ¬';
            else if (weight <= 25) sizeBox.innerText = 'ä¸­å‹çŠ¬';
            else sizeBox.innerText = 'å¤§å‹çŠ¬';
        }

        function loadBreedData() {
            return fetch(GAS_URL + `?action=pet_get_breeds`).then(res => res.json()).then(result => {
                if (result.status === 'success') { allBreedsData = result.data; renderBreedsOptions(); }
            });
        }

        function renderBreedsOptions(selectedValue = '') {
            const type = document.getElementById('p_type').value;
            const select = document.getElementById('p_breeds');
            select.innerHTML = '<option value="">è«‹é¸æ“‡å“ç¨®</option>';
            if (!allBreedsData) return;
            allBreedsData.filter(item => item.code.toString().startsWith(type)).forEach(item => {
                let option = document.createElement('option');
                option.value = item.name; option.text = item.name; select.appendChild(option);
            });
            if (selectedValue) select.value = selectedValue;
        }

        function loadPetList() {
            fetch(GAS_URL + `?action=pet_query_list&u_id=${encodeURIComponent(currentUserId)}`)
            .then(res => res.json()).then(result => {
                document.getElementById('loading-mask').style.display = 'none';
                const select = document.getElementById('pet-select');
                if (result.status === 'success' && result.data) {
                    select.innerHTML = '<option value="" disabled selected>ğŸ”½ è«‹é¸æ“‡æ¬²ä¿®æ”¹çš„å¯µç‰©...</option>';
                    result.data.forEach(pet => { select.add(new Option(`ğŸ¶ ${pet.p_name}`, pet.p_id)); });
                    if (result.data.length > 0) { select.selectedIndex = 1; loadPetDetail(result.data[0].p_id); }
                    else { switchToNewPetMode(); }
                }
            }).catch(() => document.getElementById('loading-mask').style.display = 'none');
        }

        function loadPetDetail(petId) {
            document.getElementById('loading-mask').style.display = 'flex';
            fetch(GAS_URL + `?action=pet_query_detail&p_id=${petId}`)
            .then(res => res.json()).then(result => {
                document.getElementById('loading-mask').style.display = 'none';
                if (result.status === 'success' && result.data) {
                    const d = result.data; document.getElementById('current_p_id').value = petId;
                    if(d.basic) {
                        document.getElementById('p_name').value = d.basic.p_name; 
                        document.getElementById('p_type').value = d.basic.p_type;
                        renderBreedsOptions(d.basic.p_breeds);
                        document.getElementById('p_weight').value = d.basic.p_weight || '';
                        document.getElementById('p_memo').value = d.basic.p_memo || '';
                        updateSizeDisplay();
                    }
                    // å‹¾é¸æ¡†è¼‰å…¥é‚è¼¯ (ç•¥)
                }
            });
        }

        function savePet() {
            const name = document.getElementById('p_name').value, breeds = document.getElementById('p_breeds').value;
            if (!name || !breeds) { alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½'); return; }
            document.getElementById('btn-save').disabled = true;
            let params = `?action=pet_save&u_id=${encodeURIComponent(currentUserId)}&p_id=${document.getElementById('current_p_id').value}&p_name=${encodeURIComponent(name)}&p_type=${document.getElementById('p_type').value}&p_breeds=${encodeURIComponent(breeds)}&p_weight=${document.getElementById('p_weight').value}&p_memo=${encodeURIComponent(document.getElementById('p_memo').value)}`;
            
            fetch(GAS_URL + params).then(res => res.json()).then(result => {
                if (result.status === 'success') { alert('å„²å­˜æˆåŠŸï¼'); location.reload(); }
            }).catch(() => { alert('å­˜æª”å¤±æ•—'); document.getElementById('btn-save').disabled = false; });
        }

        function switchToNewPetMode() { document.getElementById('current_p_id').value = ''; document.querySelectorAll('input, textarea').forEach(el => { if(el.type !== 'hidden') el.value = ''; }); updateSizeDisplay(); }
        function onPetSelectChange() { const id = document.getElementById('pet-select').value; if (id) loadPetDetail(id); }
        function updateLinkedCheckbox(chkId, memoId, type) { document.getElementById(chkId).checked = (document.getElementById(memoId).value.trim() !== ''); }
        function toggleHealthy(cb) { if(cb.checked) document.querySelectorAll('#sick-list input[type=checkbox]').forEach(c => c.checked = false); }
        function onSickItemChange() { document.getElementById('ps_none').checked = false; }
        function toggleWariness(cb) { if(cb.checked) document.querySelectorAll('#wariness-list input[type=checkbox]').forEach(c => c.checked = false); }
        function onWarinessItemChange() { document.getElementById('pw_none').checked = false; }
    </script>
</body>
</html>
