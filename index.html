<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Login</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        #status { margin-top: 20px; padding: 10px; background: #eee; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h3>LIFF 登入 (GitHub 版)</h3>
    <div id="status">正在初始化...</div>

    <script>
        // 【設定區】請修改這裡
        const MY_LIFF_ID = '2008965576-txfwY86y';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzteHr3C5uweBFj6FQCUtQfEEyDQpf7EIkb0vUuoiEmnPLgc37G894IbGNgvI3-5iYISg/exec'; 

        window.onload = function() {
            initializeLiff();
        };

        function initializeLiff() {
            liff.init({ liffId: MY_LIFF_ID })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        sendDataToGAS();
                    }
                })
                .catch((err) => {
                    document.getElementById('status').innerText = '初始化失敗: ' + err;
                });
        }

        function sendDataToGAS() {
            liff.getProfile().then(profile => {
                document.getElementById('status').innerText = '已取得 UserID，正在傳送...';
                
                // 【修改】將資料拼接到網址後面 (Query String)
                // 使用 encodeURIComponent 確保中文或特殊符號不會爛掉
                const queryString = "?userId=" + encodeURIComponent(profile.userId) + 
                                  "&displayName=" + encodeURIComponent(profile.displayName);
                
                const finalUrl = GAS_URL + queryString;

                // 【修改】改用 GET 請求
                fetch(finalUrl, {
                    method: 'GET',
                    // 不需要 headers 和 body
                })
                .then(response => response.json()) // 解析 JSON
                .then(data => {
                    if(data.status === 'success') {
                        document.getElementById('status').innerHTML = 
                            '<span class="success">✅ 成功！' + data.message + '</span>';
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    document.getElementById('status').innerHTML = 
                        '<span class="error">❌ 失敗: ' + error + '</span><br><small>請檢查 GAS 是否已部署為新版本</small>';
                });
            });
        }
    </script>
</body>

</html>

