<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員資料維護</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* CSS 樣式修正版 */
        body { font-family: -apple-system, sans-serif; background-color: #f5f5f5; padding: 20px; }
        .container { background: white; max-width: 500px; margin: 0 auto; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h3 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        
        /* 統一所有輸入框樣式 */
        .form-control { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            box-sizing: border-box; 
            font-size: 16px;
            background-color: #fff; /* 強制白底 */
            -webkit-appearance: none; /* 移除 iOS 預設圓角與陰影 */
            appearance: none;
            min-height: 44px; /* 確保高度一致 */
        }
        
        /* 針對日期欄位的特別修正 */
        input[type="date"].form-control {
            line-height: 1.4; /* 調整文字垂直置中 */
            display: block;
        }

        .form-control:focus { border-color: #06c755; outline: none; }
        textarea.form-control { resize: vertical; height: 80px; }

        .btn { width: 100%; padding: 12px; background-color: #06c755; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; font-weight: bold; }
        .btn:disabled { background-color: #ccc; }
        
        #loading { text-align: center; margin-top: 50px; font-size: 18px; color: #666; }
        #form-area { display: none; }
    </style>
</head>
<body>

    <div id="loading">正在讀取會員資料...</div>

    <div id="form-area" class="container">
        <h3>會員資料維護</h3>
        
        <div class="form-group">
            <label>客戶名稱</label>
            <input type="text" id="u_name" class="form-control" placeholder="請輸入姓名">
        </div>

        <div class="form-group">
            <label>電話</label>
            <input type="tel" id="u_phone" class="form-control" placeholder="09xx-xxx-xxx">
        </div>

        <div class="form-group">
            <label>地址</label>
            <input type="text" id="u_addr" class="form-control" placeholder="請輸入地址">
        </div>

        <div class="form-group">
            <label>生日</label>
            <input type="date" id="u_birthday" class="form-control">
        </div>

        <div class="form-group">
            <label>備註</label>
            <textarea id="u_memo" class="form-control" placeholder="備註事項..."></textarea>
        </div>

        <button id="btn-save" class="btn" onclick="saveData()">存檔</button>
    </div>

    <script>
        // 【設定區】
        const MY_LIFF_ID = '2008965576-txfwY86y';
        // 請確認這裡是您最新的 GAS 網址 (結尾是 /exec)
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzteHr3C5uweBFj6FQCUtQfEEyDQpf7EIkb0vUuoiEmnPLgc37G894IbGNgvI3-5iYISg/exec';

        let currentUserId = '';

        window.onload = function() {
            initializeLiff();
        };

        function initializeLiff() {
            liff.init({ liffId: MY_LIFF_ID })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        liff.getProfile().then(profile => {
                            currentUserId = profile.userId;
                            let displayName = profile.displayName;
                            checkUserStatus(currentUserId, displayName);
                        });
                    }
                })
                .catch((err) => {
                    alert('LIFF 初始化失敗: ' + err);
                });
        }

        function checkUserStatus(userId, defaultName) {
            const url = GAS_URL + '?action=query&u_id=' + userId;

            fetch(url)
            .then(res => res.json())
            .then(result => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('form-area').style.display = 'block';

                if (result.status === 'exist') {
                    let data = result.data;
                    document.getElementById('u_name').value = data.name;
                    document.getElementById('u_phone').value = data.phone;
                    document.getElementById('u_addr').value = data.addr;
                    document.getElementById('u_birthday').value = data.birthday;
                    document.getElementById('u_memo').value = data.memo;
                } else {
                    document.getElementById('u_name').value = defaultName;
                }
            })
            .catch(err => {
                document.getElementById('loading').innerText = '讀取失敗，請重新整理';
                // 這裡會跳出 alert 幫助除錯
                alert('連線錯誤: ' + err); 
            });
        }

        function saveData() {
            const btn = document.getElementById('btn-save');
            
            const name = document.getElementById('u_name').value;
            const phone = document.getElementById('u_phone').value;
            const addr = document.getElementById('u_addr').value;
            const birthday = document.getElementById('u_birthday').value;
            const memo = document.getElementById('u_memo').value;

            if(!name) { alert('請輸入名稱'); return; }

            btn.disabled = true;
            btn.innerText = '儲存中...';

            const params = `?action=save` +
                           `&u_id=${encodeURIComponent(currentUserId)}` +
                           `&name=${encodeURIComponent(name)}` +
                           `&phone=${encodeURIComponent(phone)}` +
                           `&addr=${encodeURIComponent(addr)}` +
                           `&birthday=${encodeURIComponent(birthday)}` +
                           `&memo=${encodeURIComponent(memo)}`;

            const url = GAS_URL + params;

            fetch(url)
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    alert(result.message);
                    liff.closeWindow();
                } else {
                    alert('存檔失敗: ' + result.message);
                    btn.disabled = false;
                    btn.innerText = '存檔';
                }
            })
            .catch(err => {
                alert('存檔發生錯誤: ' + err);
                btn.disabled = false;
                btn.innerText = '存檔';
            });
        }
    </script>
</body>
</html>
